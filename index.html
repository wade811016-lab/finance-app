<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¡å‹™ç³»çµ±é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        sys: {
                            bg: '#0a0a12',
                            panel: 'rgba(20, 20, 35, 0.95)',
                            blue: '#00e1ff',
                            purple: '#9d00ff',
                            text: '#e0e0ff',
                            danger: '#ff3333',
                            success: '#33ff57',
                            warn: '#ffbb00',
                            gray: '#94a3b8'
                        }
                    },
                    boxShadow: {
                        'neon-blue': '0 0 5px theme("colors.sys.blue"), 0 0 15px theme("colors.sys.blue")',
                    }
                }
            }
        }
    </script>

    <style>
        :root { color-scheme: dark; }
        
        body { 
            background-color: theme('colors.sys.bg'); 
            color: theme('colors.sys.text'); 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.sys.bg'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.sys.blue'); }

        .sys-panel {
            background: theme('colors.sys.panel');
            border: 1px solid theme('colors.sys.blue');
            box-shadow: inset 0 0 10px rgba(0, 225, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .sys-panel::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, theme('colors.sys.blue'), transparent);
        }

        input:not([type="checkbox"]), select, textarea {
            background-color: #1a1a2e !important;
            border: 1px solid theme('colors.sys.blue') !important;
            color: theme('colors.sys.text') !important;
            border-radius: 0 !important;
            padding: 0.75rem !important;
            transition: none !important; 
            -webkit-appearance: none;
            appearance: none;
            color-scheme: dark; 
        }
        
        input[type="checkbox"] {
            -webkit-appearance: checkbox !important;
            appearance: auto !important;
            accent-color: theme('colors.sys.blue'); 
            width: 1.25rem; 
            height: 1.25rem;
            cursor: pointer;
            border: 1px solid theme('colors.sys.blue');
            background-color: transparent;
        }

        input:focus, select:focus, textarea:focus {
            outline: none !important;
            box-shadow: theme('boxShadow.neon-blue') !important;
            background-color: #232342 !important;
        }

        select option { 
            background-color: #0a0a12 !important; 
            color: #e0e0ff !important; 
            padding: 10px; 
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2300e1ff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; 
            background-repeat: no-repeat; 
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem !important; 
        }

        .dashboard-select { 
            padding-top: 0 !important; 
            padding-bottom: 0 !important; 
            padding-left: 0.75rem !important;
            height: 2.5rem; 
            line-height: 2.5rem;
            min-width: 5rem; 
            width: auto;
        }

        .sys-btn {
            border: 1px solid theme('colors.sys.blue'); color: theme('colors.sys.blue');
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
            transition: all 0.3s ease; border-radius: 0; position: relative; overflow: hidden;
            padding: 0.75rem 1.5rem; cursor: pointer; background: transparent;
        }
        .sys-btn:hover { background: theme('colors.sys.blue'); color: theme('colors.sys.bg'); box-shadow: theme('boxShadow.neon-blue'); }
        .sys-btn-danger { border-color: theme('colors.sys.danger'); color: theme('colors.sys.danger'); }
        .sys-btn-danger:hover { background: theme('colors.sys.danger'); color: white; box-shadow: 0 0 15px theme('colors.sys.danger'); }
        .sys-btn-purple { border-color: theme('colors.sys.purple'); color: theme('colors.sys.purple'); }
        .sys-btn-purple:hover { background: theme('colors.sys.purple'); color: white; box-shadow: theme('boxShadow.neon-purple'); }

        .nav-item.active { color: theme('colors.sys.blue'); border-top: 2px solid theme('colors.sys.blue'); text-shadow: 0 0 10px theme('colors.sys.blue'); }
        
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .system-toast { animation: slideInRight 0.4s ease-out forwards; border-left: 4px solid theme('colors.sys.blue'); }
        
        #main-content { padding-bottom: 160px !important; }
        
        /* [V9.7 Fix] Improved Modal Constraint for Mobile */
        .modal-constraint {
            max-height: 85vh; /* Safer height for mobile browsers */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent double scrollbars */
        }
        .modal-header {
            flex-shrink: 0; /* Header never shrinks */
            background-color: theme('colors.sys.bg');
            z-index: 10;
        }
        .modal-body {
            flex-grow: 1;
            overflow-y: auto; /* Internal scroll */
            min-height: 0;
            overscroll-behavior: contain; /* Prevent scrolling parent page */
        }

        .split-row { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col">

    <header class="sticky top-0 z-20 sys-panel p-4 flex justify-between items-center shadow-lg bg-sys-bg">
        <h1 class="text-2xl font-bold tracking-wider uppercase text-sys-blue drop-shadow-[0_0_5px_rgba(0,225,255,0.8)]">
            <i class="fa-solid fa-microchip mr-2"></i>è²¡å‹™ç³»çµ±
        </h1>
        <button onclick="openTransactionModal()" class="sys-btn text-sm px-4 py-2 flex items-center">
            <i class="fa-solid fa-plus mr-2"></i> ç´€éŒ„é‡‘æµ
        </button>
    </header>

    <main id="main-content" class="flex-1 overflow-y-auto p-4 space-y-6 relative"></main>

    <nav class="fixed bottom-0 left-0 right-0 sys-panel z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)] bg-sys-bg">
        <div class="flex justify-around">
            <button onclick="switchView('view-accounts')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-accounts">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-xs uppercase">å¸³æˆ¶ç¸½è¦½</span>
            </button>
            <button onclick="switchView('view-dashboard')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center active" id="nav-dashboard">
                <i class="fa-solid fa-chart-line text-xl mb-1"></i><span class="text-xs uppercase">å„€è¡¨æ¿</span>
            </button>
            <button onclick="switchView('view-records')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-records">
                <i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-xs uppercase">ç´€éŒ„</span>
            </button>
            <button onclick="switchView('view-settings')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-settings">
                <i class="fa-solid fa-gears text-xl mb-1"></i><span class="text-xs uppercase">è¨­å®š</span>
            </button>
        </div>
    </nav>

    <div id="modal-tx" class="fixed inset-0 z-50 hidden justify-center items-end sm:items-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('modal-tx')"></div>
        <div class="relative w-full sm:w-auto sm:max-w-lg bg-sys-bg rounded-t-2xl sm:rounded-2xl shadow-[0_-5px_20px_rgba(0,225,255,0.2)] animate-[slideUp_0.3s_ease-out] modal-constraint">
            <div class="p-6 border-b border-sys-blue/30 pb-3 modal-header flex justify-between items-center">
                <h3 class="text-xl font-bold text-sys-blue uppercase" id="modal-tx-title"><i class="fa-solid fa-pen-to-square mr-2"></i>æ–°å¢ç´€éŒ„</h3>
                <button onclick="toggleModal('modal-tx')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 modal-body custom-scrollbar">
                <form id="form-tx" class="space-y-5">
                    <input type="hidden" id="inp-id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">æ—¥æœŸ</label>
                            <input type="date" id="inp-date" required class="w-full">
                        </div>
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">é¡å‹</label>
                            <select id="inp-type" class="w-full" onchange="updateCategoryOptions()">
                                <option value="expense">æ”¯å‡º</option>
                                <option value="income">æ”¶å…¥</option>
                                <option value="transfer">è½‰å¸³ / ç¹³è²»</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="option-deferred" class="hidden">
                         <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-warn/50">
                            <input type="checkbox" id="inp-deferred" class="form-checkbox h-5 w-5 text-sys-warn bg-transparent border-sys-warn rounded-none focus:ring-0 focus:ring-offset-0">
                            <span class="text-sys-text font-bold text-sys-warn">â³ é æ”¶å¸³æ¬¾ (æš«ä¸è¨ˆå…¥æ”¶å…¥)</span>
                        </label>
                    </div>

                    <div id="option-realization" class="hidden">
                        <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-success/50">
                           <input type="checkbox" id="inp-realization" class="form-checkbox h-5 w-5 text-sys-success bg-transparent border-sys-success rounded-none focus:ring-0 focus:ring-offset-0">
                           <span class="text-sys-text font-bold text-sys-success">ğŸš€ èªåˆ—ç‚ºå¯¦è³ªæ”¶å…¥ (æ ¸éŠ·)</span>
                       </label>
                       <p class="text-xs text-gray-400 mt-1 pl-2">* å‹¾é¸å¾Œï¼Œæ­¤ç­†è½‰å¸³é‡‘é¡å°‡è¨ˆå…¥ã€Œæœ¬æœˆæ”¶å…¥ã€åœ–è¡¨ã€‚</p>
                   </div>

                   <div id="option-exclude" class="hidden">
                        <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-gray/50">
                            <input type="checkbox" id="inp-excluded" class="form-checkbox h-5 w-5 text-sys-gray bg-transparent border-sys-gray rounded-none focus:ring-0 focus:ring-offset-0">
                            <span class="text-sys-text font-bold text-sys-gray">ğŸš« ä¸åˆ—å…¥æ”¶æ”¯çµ±è¨ˆ</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1 pl-2">* å‹¾é¸å¾Œï¼Œæ­¤ç­†é‡‘é¡åªæœƒèª¿æ•´å¸³æˆ¶é¤˜é¡ï¼Œä¸è¨ˆå…¥åœ–è¡¨ã€‚</p>
                   </div>

                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">é‡‘é¡</label>
                        <div class="flex gap-2">
                            <input type="number" id="inp-amount" placeholder="0" required min="0" step="0.01" class="w-full text-2xl font-bold text-sys-blue">
                            <button type="button" onclick="openSplitModal()" class="sys-btn px-4 bg-sys-blue/10 border-sys-purple text-sys-purple hover:bg-sys-purple hover:text-white" title="æ‹†å¸³è¨ˆç®—æ©Ÿ">
                                <i class="fa-solid fa-scissors"></i> æ‹†å¸³
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4" id="account-group">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase" id="lbl-from">å¸³æˆ¶</label>
                            <select id="inp-account-from" required class="w-full"></select>
                        </div>
                         <div id="group-account-to" class="hidden">
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">è½‰å…¥å¸³æˆ¶</label>
                            <select id="inp-account-to" class="w-full"></select>
                        </div>
                    </div>
                    <div id="group-category">
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">åˆ†é¡</label>
                         <select id="inp-category" required class="w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">å‚™è¨» / æè¿°</label>
                        <input type="text" id="inp-note" placeholder="ä¾‹å¦‚ï¼šå…¨å®¶åˆé¤" class="w-full">
                    </div>
                    <button type="submit" class="sys-btn w-full py-4 text-lg mb-4"><i class="fa-solid fa-floppy-disk mr-2"></i> ç¢ºèªç™»éŒ„</button>
                    <button type="button" id="btn-delete-tx" class="hidden sys-btn sys-btn-danger w-full mt-2" onclick="deleteCurrentTx()"><i class="fa-solid fa-trash mr-2"></i> åˆªé™¤ç´€éŒ„</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-split" class="fixed inset-0 z-[60] hidden justify-center items-end sm:items-center">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm" onclick="toggleModal('modal-split')"></div>
        <div class="relative w-full sm:w-auto sm:max-w-lg bg-sys-bg rounded-t-2xl sm:rounded-2xl modal-constraint">
            <div class="p-4 border-b border-sys-blue flex justify-between items-center bg-sys-panel modal-header">
                <h3 class="text-xl font-bold text-sys-purple uppercase"><i class="fa-solid fa-scissors mr-2"></i>æ¶ˆè²»æ‹†å¸³</h3>
                <button onclick="toggleModal('modal-split')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-4 modal-body custom-scrollbar">
                <div class="mb-4 text-center">
                    <p class="text-gray-400 text-xs uppercase tracking-widest mb-1">ç¸½é‡‘é¡</p>
                    <div class="text-3xl font-bold text-sys-blue" id="split-display-total">$0</div>
                </div>
                <div id="split-rows-container" class="space-y-3"></div>
                <div id="split-ghost-row" class="hidden mt-3 p-3 border border-dashed border-gray-600 rounded bg-gray-900/50 opacity-70 cursor-pointer hover:opacity-100 hover:border-sys-blue hover:bg-sys-blue/5 transition-all" onclick="addSplitRowFromGhost()">
                    <div class="flex items-center justify-between text-gray-400 pointer-events-none">
                        <span><i class="fa-solid fa-plus-circle mr-2"></i> é»æ“Šè‡ªå‹•å¡«å…¥å‰©é¤˜æ¬¾é …</span>
                        <span class="font-bold font-mono text-sys-purple" id="split-ghost-amount">$0</span>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-sys-blue bg-sys-panel modal-header flex gap-3">
                <div class="flex-1 text-xs flex flex-col justify-center">
                    <span class="text-gray-400">å·²åˆ†é…: <span id="split-display-sum" class="text-sys-text font-bold">$0</span></span>
                    <span class="text-gray-400">å‰©é¤˜: <span id="split-display-remain" class="text-sys-danger font-bold">$0</span></span>
                </div>
                <button onclick="saveSplit()" class="sys-btn flex-1 !border-sys-purple !text-sys-purple hover:!bg-sys-purple hover:!text-white">
                    <i class="fa-solid fa-check-double mr-2"></i> ç¢ºèªæ‹†å¸³
                </button>
            </div>
        </div>
    </div>

    <div id="modal-account" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-account')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 bg-sys-bg">
            <h3 class="text-xl font-bold text-sys-blue uppercase mb-4" id="modal-account-title">æ–°å¢/ç·¨è¼¯å¸³æˆ¶</h3>
            <input type="hidden" id="inp-acc-original-name">
            <div class="space-y-4">
                <div>
                    <label class="block text-sys-blue text-sm font-bold mb-2">å¸³æˆ¶åç¨±</label>
                    <input type="text" id="inp-acc-name" class="w-full" placeholder="ä¾‹å¦‚ï¼šæ°¸è± (é æ”¶æš«å­˜)">
                </div>
                <div>
                    <label class="block text-sys-blue text-sm font-bold mb-2">ç•¶å‰/åˆå§‹ é¤˜é¡</label>
                    <input type="number" id="inp-acc-balance" class="w-full" step="1" placeholder="0">
                </div>
                <button onclick="saveAccount()" class="sys-btn w-full">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-cats" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-cats')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 h-3/4 flex flex-col bg-sys-bg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-sys-blue uppercase"><i class="fa-solid fa-tags mr-2"></i>åˆ†é¡æ¶æ§‹ç®¡ç†</h3>
                <button onclick="toggleModal('modal-cats')" class="text-sys-text"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex mb-4 border-b border-sys-blue/30 shrink-0">
                <button onclick="switchCatType('expense')" id="tab-cat-expense" class="flex-1 py-2 text-sm text-sys-blue border-b-2 border-sys-blue font-bold">æ”¯å‡º</button>
                <button onclick="switchCatType('income')" id="tab-cat-income" class="flex-1 py-2 text-sm text-gray-500">æ”¶å…¥</button>
            </div>
            <div class="flex gap-2 mb-4 shrink-0">
                <input type="text" id="new-cat-name" placeholder="æ–°å¢åˆ†é¡åç¨±..." class="flex-1">
                <button onclick="addCategory()" class="sys-btn py-1 px-4"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="cat-list-container" class="overflow-y-auto custom-scrollbar flex-1 space-y-1 pr-2"></div>
        </div>
    </div>

    <div id="modal-rules" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-rules')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 h-3/4 flex flex-col bg-sys-bg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-sys-blue uppercase"><i class="fa-solid fa-robot mr-2"></i>è‡ªå‹•åˆ†é¡è¨˜æ†¶åº«</h3>
                <button onclick="toggleModal('modal-rules')" class="text-sys-text"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-xs text-gray-400 mb-4 shrink-0">ç•¶å‚™è¨»åŒ…å«ç‰¹å®šé—œéµå­—æ™‚ï¼Œç³»çµ±å°‡è‡ªå‹•æ­¸é¡ã€‚</p>
            <div id="rule-list-container" class="overflow-y-auto custom-scrollbar flex-1 space-y-2 pr-2"></div>
        </div>
    </div>

    <div id="modal-db" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-db')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 border-sys-danger/50 shadow-[0_0_30px_rgba(255,51,51,0.1)] bg-sys-bg">
            <div class="flex justify-between items-center mb-6 border-b border-sys-danger/30 pb-3">
                <h3 class="text-xl font-bold text-sys-danger uppercase"><i class="fa-solid fa-shield-halved mr-2"></i>ç³»çµ±æ ¸å¿ƒ</h3>
                <button onclick="toggleModal('modal-db')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="space-y-4">
                <button onclick="exportData()" class="sys-btn w-full"><i class="fa-solid fa-file-export mr-2"></i> åŒ¯å‡ºå‚™ä»½æª”æ¡ˆ</button>
                <div class="relative">
                    <button class="sys-btn w-full"><i class="fa-solid fa-file-import mr-2"></i> åŒ¯å…¥é‚„åŸ</button>
                    <input type="file" id="import-file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="importData(event)">
                </div>
                <div class="border-t border-sys-danger/30 my-4"></div>
                <button onclick="resetData()" class="sys-btn sys-btn-danger w-full"><i class="fa-solid fa-skull mr-2"></i> æ ¼å¼åŒ–é‡ç½®ç³»çµ±</button>
            </div>
        </div>
    </div>

    <div id="system-toast-container" class="fixed top-20 right-4 z-50 flex flex-col space-y-4 pointer-events-none"></div>

    <script>
        const APP_ID = 'finsys_solo_v9_2';
        const DEFAULT_ACCOUNTS = ['æ°¸è± (æ´»å­˜)', 'æ°¸è± (é æ”¶æš«å­˜)', 'ç¾é‡‘', 'ä¿¡ç”¨å¡'];
        const DEFAULT_CATEGORIES = {
            expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'å…¶ä»–æ”¯å‡º'],
            income: ['è–ªè³‡', 'èª²ç¨‹æ”¶å…¥', 'é æ”¶å­¸è²»', 'æŠ•è³‡'],
            transfer: ['å…§éƒ¨è½‰å¸³', 'æ ¸éŠ·èªåˆ—', 'ä¿¡ç”¨å¡ç¹³è²»']
        };

        let state = {
            transactions: [],
            accounts: [...DEFAULT_ACCOUNTS],
            categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
            keywordMap: {}, 
            settings: { currency: 'TWD' },
            ui: {
                currentView: 'view-accounts', 
                chartYear: new Date().getFullYear(),
                chartMonth: 'all',
                activeAccountDetail: null,
                catManageType: 'expense',
                breakdownTab: 'expense'
            }
        };

        let splitState = {
            total: 0,
            rows: [] 
        };
        let donutChart = null; 

        function showSystemToast(message, type = 'success') {
            const container = document.getElementById('system-toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-triangle-exclamation';
            const color = type === 'success' ? 'sys-success' : 'sys-danger';
            toast.className = `system-toast sys-panel p-4 flex items-center shadow-lg border-${color} mb-3 pointer-events-auto`;
            toast.innerHTML = `<i class="fa-solid ${icon} text-${color} text-xl mr-3"></i><span class="font-bold uppercase tracking-wider text-${color}">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3400);
        }

        const toggleModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modalId === 'modal-tx' || modalId === 'modal-split') {
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            } else {
                modal.classList.toggle('hidden');
            }
        };

        const formatCurrency = (num) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: state.settings.currency, minimumFractionDigits: 0 }).format(num);

        const loadData = () => {
            const saved = localStorage.getItem(APP_ID);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed, keywordMap: parsed.keywordMap || {} };
                    state.transactions = state.transactions.map(tx => ({ 
                        ...tx, 
                        isVerified: tx.hasOwnProperty('isVerified') ? tx.isVerified : true,
                        isRealization: tx.hasOwnProperty('isRealization') ? tx.isRealization : false,
                        isExcluded: tx.hasOwnProperty('isExcluded') ? tx.isExcluded : false
                    }));
                } catch (e) { showSystemToast("è³‡æ–™è¼‰å…¥å¤±æ•—", 'error'); }
            }
        };
        const saveData = () => { localStorage.setItem(APP_ID, JSON.stringify(state)); renderApp(); };

        const upsertTransaction = (tx) => {
            const index = state.transactions.findIndex(t => t.id === tx.id);
            if (index > -1) {
                state.transactions[index] = { ...state.transactions[index], ...tx };
                showSystemToast("ç´€éŒ„å·²æ›´æ–°");
            } else {
                state.transactions.unshift({ id: Date.now().toString() + Math.random().toString(36).substr(2,5), createdAt: new Date().toISOString(), ...tx });
                showSystemToast("ç´€éŒ„å·²æ–°å¢");
                learnKeyword(tx.note, tx.category, tx.type);
            }
            saveData();
        };

        const deleteCurrentTx = () => {
            const id = document.getElementById('inp-id').value;
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                saveData();
                toggleModal('modal-tx');
                showSystemToast("ç´€éŒ„å·²åˆªé™¤", 'error');
            }
        };

        const learnKeyword = (note, category, type) => {
            if (!note || type === 'transfer') return;
            const keyword = note.trim().substring(0, 2); 
            if (keyword.length >= 2 && !state.keywordMap[keyword]) state.keywordMap[keyword] = category;
        };

        const getBalance = (accountName) => {
            let balance = 0;
            state.transactions.forEach(tx => {
                const amt = parseFloat(tx.amount);
                if (tx.type === 'income' && tx.accountFrom === accountName) balance += amt;
                if (tx.type === 'expense' && tx.accountFrom === accountName) balance -= amt;
                if (tx.type === 'transfer') {
                    if (tx.accountFrom === accountName) balance -= amt;
                    if (tx.accountTo === accountName) balance += amt;
                }
            });
            return balance;
        };

        const shouldCountTx = (tx) => {
            if (tx.isExcluded) return false;
            if (tx.category === 'ç³»çµ±èª¿æ•´' || tx.category === 'å¸³æˆ¶é¤˜é¡èª¿æ•´') return false;
            return true;
        };

        const openSplitModal = () => {
            const amountStr = document.getElementById('inp-amount').value;
            if(!amountStr || parseFloat(amountStr) <= 0) return showSystemToast("è«‹å…ˆè¼¸å…¥ç¸½é‡‘é¡", "error");
            
            const total = parseFloat(amountStr);
            const parentType = document.getElementById('inp-type').value;
            const parentCat = document.getElementById('inp-category').value;
            
            splitState = {
                total: total,
                rows: [
                    { id: Date.now(), type: parentType, category: parentCat, amount: total, note: '' }
                ]
            };
            
            document.getElementById('split-display-total').innerText = formatCurrency(total);
            renderSplitRows();
            toggleModal('modal-split');
        };

        const renderSplitRows = () => {
            const container = document.getElementById('split-rows-container');
            container.innerHTML = '';
            let sum = 0;
            splitState.rows.forEach((row, index) => {
                sum += parseFloat(row.amount) || 0;
                const rowEl = document.createElement('div');
                rowEl.className = 'split-row sys-panel p-3 border-l-4 border-sys-purple';
                rowEl.innerHTML = `
                    <div class="flex gap-2 mb-2">
                        <select onchange="updateSplitRow(${index}, 'type', this.value)" class="w-1/3 text-xs p-1 h-8 !bg-sys-bg">
                            <option value="expense" ${row.type==='expense'?'selected':''}>æ”¯å‡º</option>
                            <option value="income" ${row.type==='income'?'selected':''}>æ”¶å…¥</option>
                        </select>
                        <select onchange="updateSplitRow(${index}, 'category', this.value)" class="w-2/3 text-xs p-1 h-8 !bg-sys-bg split-cat-select" data-val="${row.category}" data-type="${row.type}">
                        </select>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="number" value="${row.amount}" onchange="updateSplitRow(${index}, 'amount', this.value)" class="w-24 font-bold text-sys-blue text-right h-10" placeholder="0">
                        <input type="text" value="${row.note}" onchange="updateSplitRow(${index}, 'note', this.value)" class="flex-1 h-10 text-sm" placeholder="å‚™è¨»...">
                        ${splitState.rows.length > 1 ? `<button onclick="removeSplitRow(${index})" class="text-gray-500 hover:text-sys-danger px-2"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(rowEl);
                const catSelect = rowEl.querySelector('.split-cat-select');
                const cats = state.categories[row.type] || [];
                cats.forEach(c => catSelect.add(new Option(c, c, false, c === row.category)));
            });
            const remain = splitState.total - sum;
            document.getElementById('split-display-sum').innerText = formatCurrency(sum);
            const remainEl = document.getElementById('split-display-remain');
            remainEl.innerText = formatCurrency(remain);
            remainEl.className = remain === 0 ? 'text-sys-success font-bold' : 'text-sys-danger font-bold';
            const ghost = document.getElementById('split-ghost-row');
            if (remain > 0) {
                ghost.classList.remove('hidden');
                document.getElementById('split-ghost-amount').innerText = formatCurrency(remain);
            } else {
                ghost.classList.add('hidden');
            }
        };

        const updateSplitRow = (index, field, value) => {
            if (field === 'amount') value = parseFloat(value) || 0;
            splitState.rows[index][field] = value;
            if (field === 'type') {
                 const cats = state.categories[value] || [];
                 splitState.rows[index].category = cats[0] || '';
            }
            renderSplitRows();
        };

        const addSplitRowFromGhost = () => {
            const currentSum = splitState.rows.reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
            const remain = splitState.total - currentSum;
            if (remain <= 0) return;
            const baseRow = splitState.rows[splitState.rows.length - 1];
            splitState.rows.push({
                id: Date.now(),
                type: baseRow.type,
                category: baseRow.category,
                amount: remain, 
                note: ''
            });
            renderSplitRows();
        };

        const removeSplitRow = (index) => {
            splitState.rows.splice(index, 1);
            renderSplitRows();
        };

        const saveSplit = () => {
            const sum = splitState.rows.reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
            if (Math.abs(sum - splitState.total) > 1) { 
                if (!confirm(`ç›®å‰åˆ†é…ç¸½é¡ (${sum}) èˆ‡ç¸½é‡‘é¡ (${splitState.total}) ä¸ç¬¦ã€‚ç¢ºå®šè¦å„²å­˜å—ï¼Ÿ`)) return;
            }
            const date = document.getElementById('inp-date').value;
            const accountFrom = document.getElementById('inp-account-from').value;
            let savedCount = 0;
            splitState.rows.forEach(row => {
                const tx = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2,5),
                    date: date,
                    type: row.type,
                    amount: parseFloat(row.amount),
                    category: row.category,
                    accountFrom: accountFrom,
                    note: row.note,
                    isVerified: true,
                    isRealization: false,
                    isExcluded: false 
                };
                upsertTransaction(tx);
                savedCount++;
            });
            showSystemToast(`æˆåŠŸæ‹†åˆ†ç‚º ${savedCount} ç­†ç´€éŒ„`);
            toggleModal('modal-split');
            toggleModal('modal-tx'); 
        };

        const switchView = (viewId) => {
            state.ui.currentView = viewId;
            if (viewId !== 'view-accounts') state.ui.activeAccountDetail = null;
            renderApp();
        };

        const renderApp = () => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(state.ui.currentView.replace('view', 'nav')).classList.add('active');
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';
            switch(state.ui.currentView) {
                case 'view-dashboard': renderDashboard(mainContent); break;
                case 'view-records': renderRecords(mainContent); break;
                case 'view-accounts': renderAccountsView(mainContent); break;
                case 'view-settings': renderSettings(mainContent); break;
            }
        };

        const renderDashboard = (container) => {
            const now = new Date();
            const thisMonthPrefix = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            let incomeMonth = 0, expenseMonth = 0;
            
            state.transactions.filter(tx => tx.date.startsWith(thisMonthPrefix)).forEach(tx => {
                if (!shouldCountTx(tx)) return;
                const amt = parseFloat(tx.amount);
                if (tx.type === 'income' && tx.isVerified !== false) incomeMonth += amt;
                if (tx.type === 'transfer' && tx.isRealization === true) incomeMonth += amt;
                if (tx.type === 'expense') expenseMonth += amt;
            });
            const netMonth = incomeMonth - expenseMonth;

            const yearOptions = getAvailableYears().map(y => `<option value="${y}" ${y === state.ui.chartYear ? 'selected' : ''}>${y} å¹´</option>`).join('');
            const monthOptions = `<option value="all" ${state.ui.chartMonth === 'all' ? 'selected' : ''}>å…¨å¹´</option>` + 
                                 Array.from({length: 12}, (_, i) => `<option value="${i}" ${state.ui.chartMonth == i ? 'selected' : ''}>${i+1} æœˆ</option>`).join('');

            const activeTab = state.ui.breakdownTab || 'expense';
            const tabClass = (t) => t === activeTab ? 'text-sys-blue border-b-2 border-sys-blue font-bold' : 'text-gray-500';

            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="sys-panel p-4 border-l-4 border-sys-success">
                        <h3 class="text-xs uppercase text-sys-success font-bold mb-1">æœ¬æœˆæ”¶å…¥</h3>
                        <p class="text-2xl font-bold">${formatCurrency(incomeMonth)}</p>
                    </div>
                     <div class="sys-panel p-4 border-l-4 border-sys-danger">
                        <h3 class="text-xs uppercase text-sys-danger font-bold mb-1">æœ¬æœˆæ”¯å‡º</h3>
                        <p class="text-2xl font-bold">${formatCurrency(expenseMonth)}</p>
                    </div>
                    <div class="sys-panel p-4 col-span-2 flex justify-between items-center ${netMonth >= 0 ? 'border-sys-blue' : 'border-sys-danger'} border-2">
                        <div>
                            <h3 class="text-sm uppercase text-sys-blue font-bold mb-1">æœ¬æœˆæ·¨ç¾é‡‘æµ</h3>
                            <p class="text-3xl font-bold ${netMonth >= 0 ? 'text-sys-success' : 'text-sys-danger'} drop-shadow-[0_0_5px_currentColor]">${formatCurrency(netMonth)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="sys-panel p-4 relative z-10 mb-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h3 class="text-sys-blue uppercase font-bold tracking-widest"><i class="fa-solid fa-chart-line mr-2"></i>æ”¶æ”¯è¶¨å‹¢</h3>
                        <div class="flex space-x-2">
                            <select onchange="updateChartFilter('year', this.value)" class="sys-btn dashboard-select bg-sys-bg text-sys-text border-sys-blue">${yearOptions}</select>
                            <select onchange="updateChartFilter('month', this.value)" class="sys-btn dashboard-select bg-sys-bg text-sys-text border-sys-blue">${monthOptions}</select>
                        </div>
                    </div>
                    <div class="h-64"><canvas id="mainChart"></canvas></div>
                </div>

                <div class="sys-panel p-4 relative z-10 mb-6">
                    <h3 class="text-sys-blue uppercase font-bold tracking-widest mb-4"><i class="fa-solid fa-chart-pie mr-2"></i>åˆ†é¡çµæ§‹åˆ†æ</h3>
                    <div class="flex mb-4 border-b border-sys-blue/30">
                        <button onclick="updateBreakdownTab('expense')" class="flex-1 py-2 text-sm ${tabClass('expense')}">æ”¯å‡º</button>
                        <button onclick="updateBreakdownTab('income')" class="flex-1 py-2 text-sm ${tabClass('income')}">æ”¶å…¥</button>
                        <button onclick="updateBreakdownTab('excluded')" class="flex-1 py-2 text-sm ${tabClass('excluded')} text-sys-warn"><i class="fa-solid fa-eye-slash mr-1"></i>è¿½è¹¤é …</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="h-48 w-full md:w-1/2 flex justify-center">
                            <canvas id="donutChart"></canvas>
                        </div>
                        <div class="w-full md:w-1/2 space-y-3" id="breakdown-list">
                        </div>
                    </div>
                </div>

                <div class="sys-panel p-4 border-t border-sys-blue/20">
                    <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase">è©²å€é–“å¸³å‹™æ˜ç´°</h4>
                    <div id="dashboard-tx-list" class="space-y-3"></div>
                </div>
            `;
            
            renderChart();
            renderDashboardList(); 
            renderBreakdown(); 
        };

        const updateBreakdownTab = (tab) => {
            state.ui.breakdownTab = tab;
            renderApp();
        };

        const renderBreakdown = () => {
            const ctx = document.getElementById('donutChart').getContext('2d');
            const listContainer = document.getElementById('breakdown-list');
            const type = state.ui.breakdownTab; 
            const targetYear = state.ui.chartYear;
            const targetMonth = state.ui.chartMonth;

            const txs = state.transactions.filter(tx => {
                const date = new Date(tx.date);
                const matchYear = date.getFullYear() === targetYear;
                const matchMonth = targetMonth === 'all' ? true : date.getMonth() === parseInt(targetMonth);
                if (!matchYear || !matchMonth) return false;

                if (type === 'excluded') {
                    return tx.isExcluded || tx.category === 'ç³»çµ±èª¿æ•´' || tx.category === 'å¸³æˆ¶é¤˜é¡èª¿æ•´';
                } else {
                    return tx.type === type && shouldCountTx(tx); 
                }
            });

            const groups = {};
            let totalSum = 0;
            txs.forEach(tx => {
                const cat = tx.category || 'æœªåˆ†é¡';
                const amt = parseFloat(tx.amount);
                groups[cat] = (groups[cat] || 0) + amt;
                totalSum += amt;
            });

            const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]);

            if (sorted.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">æ­¤å€é–“ç„¡è³‡æ–™</div>';
                if (donutChart) donutChart.destroy();
                return;
            }

            listContainer.innerHTML = sorted.map(([cat, amt]) => {
                const pct = ((amt / totalSum) * 100).toFixed(1);
                return `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-bold">${cat}</span>
                            <span class="font-mono text-gray-400">${pct}% <span class="text-sys-text ml-2">${formatCurrency(amt)}</span></span>
                        </div>
                        <div class="w-full bg-sys-bg h-2 rounded-full overflow-hidden">
                            <div class="h-full bg-sys-blue" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            if (donutChart) donutChart.destroy();
            const chartColors = ['#00e1ff', '#9d00ff', '#ff3333', '#33ff57', '#ffbb00', '#3b82f6', '#ec4899', '#6366f1'];
            donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(i => i[0]),
                    datasets: [{
                        data: sorted.map(i => i[1]),
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${formatCurrency(ctx.raw)}` } }
                    },
                    cutout: '65%'
                }
            });
        };

        const renderDashboardList = () => {
            const container = document.getElementById('dashboard-tx-list');
            if(!container) return;
            const targetYear = state.ui.chartYear;
            const targetMonth = state.ui.chartMonth;
            const filtered = state.transactions.filter(tx => {
                const date = new Date(tx.date);
                const matchYear = date.getFullYear() === targetYear;
                const matchMonth = targetMonth === 'all' ? true : date.getMonth() === parseInt(targetMonth);
                return matchYear && matchMonth;
            });
            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">ç„¡è³‡æ–™</div>';
            } else {
                container.innerHTML = filtered.map(tx => renderTransactionItem(tx, false)).join('');
            }
        };

        const getAvailableYears = () => {
            const years = new Set([new Date().getFullYear(), new Date().getFullYear() + 1]);
            state.transactions.forEach(tx => years.add(new Date(tx.date).getFullYear()));
            return Array.from(years).sort((a, b) => b - a);
        };
        const updateChartFilter = (type, value) => {
            if (type === 'year') state.ui.chartYear = parseInt(value);
            if (type === 'month') state.ui.chartMonth = value === 'all' ? 'all' : parseInt(value);
            renderApp();
        };
        const renderChart = () => {
            const ctx = document.getElementById('mainChart').getContext('2d');
            Chart.defaults.color = '#e0e0ff'; Chart.defaults.borderColor = 'rgba(0, 225, 255, 0.1)';
            const targetYear = state.ui.chartYear; const targetMonth = state.ui.chartMonth;
            let labels = [], incomeData = [], expenseData = [];

            if (targetMonth === 'all') {
                labels = Array.from({length: 12}, (_, i) => `${i+1}æœˆ`);
                for (let i = 0; i < 12; i++) {
                    const prefix = `${targetYear}-${String(i + 1).padStart(2, '0')}`;
                    let inc = 0, exp = 0;
                    state.transactions.filter(tx => tx.date.startsWith(prefix)).forEach(tx => {
                        if (!shouldCountTx(tx)) return;
                        const amt = parseFloat(tx.amount);
                        if (tx.type === 'income' && tx.isVerified !== false) inc += amt;
                        if (tx.type === 'transfer' && tx.isRealization === true) inc += amt;
                        if (tx.type === 'expense') exp += amt;
                    });
                    incomeData.push(inc); expenseData.push(exp);
                }
            } else {
                const prefix = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}`;
                const catMap = {};
                state.transactions.filter(tx => tx.date.startsWith(prefix) && tx.type === 'expense').forEach(tx => {
                    if (!shouldCountTx(tx)) return;
                    catMap[tx.category] = (catMap[tx.category] || 0) + parseFloat(tx.amount);
                });
                const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 5);
                labels = sorted.map(i => i[0]); expenseData = sorted.map(i => i[1]);
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: targetMonth !== 'all' ? [{ label: 'å‰äº”å¤§æ”¯å‡º', data: expenseData, backgroundColor: 'rgba(255, 51, 51, 0.7)', borderColor: '#ff3333', borderWidth: 1 }]
                                     : [{ label: 'æ”¶å…¥', data: incomeData, backgroundColor: 'rgba(51, 255, 87, 0.7)', borderColor: '#33ff57', borderWidth: 1 },
                                        { label: 'æ”¯å‡º', data: expenseData, backgroundColor: 'rgba(255, 51, 51, 0.7)', borderColor: '#ff3333', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        };

        const renderAccountsView = (container) => {
            if (state.ui.activeAccountDetail) { renderAccountDetail(container, state.ui.activeAccountDetail); return; }
            const totalAsset = state.accounts.reduce((sum, acc) => sum + getBalance(acc), 0);
            let html = `
                <div class="sys-panel p-6 flex flex-col items-center justify-center mb-6 shadow-neon-blue relative overflow-hidden">
                    <div class="absolute inset-0 bg-sys-blue opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-sys-blue to-transparent pointer-events-none"></div>
                    <h2 class="text-sys-blue uppercase tracking-widest text-sm font-bold mb-2">ç³»çµ±ç¸½è³‡ç”¢</h2>
                    <p class="text-4xl font-bold text-white drop-shadow-[0_0_10px_rgba(0,225,255,0.8)]">${formatCurrency(totalAsset)}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;
            state.accounts.forEach(acc => {
                const bal = getBalance(acc);
                html += `
                    <div class="sys-panel p-5 flex justify-between items-center cursor-pointer hover:shadow-neon-blue transition-all" onclick="openAccountDetail('${acc}')">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-sys-blue/20 flex items-center justify-center border border-sys-blue mr-4"><i class="fa-solid fa-credit-card text-sys-blue"></i></div>
                            <span class="font-bold text-lg uppercase">${acc}</span>
                        </div>
                        <span class="font-bold text-xl ${bal >= 0 ? 'text-sys-blue' : 'text-sys-danger'}">${formatCurrency(bal)}</span>
                    </div>`;
            });
            html += `<button onclick="openAccountModal()" class="sys-panel p-5 flex items-center justify-center border-dashed border-sys-blue/50 text-sys-blue/70 hover:text-sys-blue hover:border-sys-blue transition-all uppercase font-bold tracking-widest"><i class="fa-solid fa-plus-circle mr-2"></i> æ“´å……å¸³æˆ¶æ§½ä½</button></div>`;
            container.innerHTML = html;
        };

        const openAccountDetail = (acc) => { state.ui.activeAccountDetail = acc; renderApp(); };
        const renderAccountDetail = (container, acc) => {
            const bal = getBalance(acc);
            const accountTx = state.transactions.filter(tx => tx.accountFrom === acc || tx.accountTo === acc);
            container.innerHTML = `
                <button onclick="state.ui.activeAccountDetail = null; renderApp()" class="mb-4 text-sys-blue hover:underline flex items-center uppercase font-bold"><i class="fa-solid fa-chevron-left mr-2"></i> è¿”å›å¸³æˆ¶ç¸½è¦½</button>
                <div class="sys-panel p-6 mb-6 border-l-4 border-sys-blue flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold uppercase text-sys-blue mb-2">${acc}</h2>
                        <p class="text-3xl font-bold ${bal >= 0 ? 'text-sys-blue' : 'text-sys-danger'}">${formatCurrency(bal)}</p>
                    </div>
                    <button onclick="openAccountModal('${acc}')" class="sys-btn text-xs"><i class="fa-solid fa-pen mr-2"></i>ç·¨è¼¯å¸³æˆ¶</button>
                </div>
                <h3 class="text-sys-blue uppercase font-bold mb-4 tracking-widest"><i class="fa-solid fa-list-ul mr-2"></i>äº¤æ˜“æµæ°´ç´€éŒ„</h3>
                <div class="space-y-3">
                    ${accountTx.length === 0 ? '<div class="sys-panel p-8 text-center text-gray-400">å°šç„¡ç´€éŒ„</div>' : accountTx.map(tx => renderTransactionItem(tx)).join('')}
                </div>
            `;
        };

        const renderRecords = (container) => {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-sys-blue uppercase tracking-widest">è¿‘æœŸç³»çµ±ç´€éŒ„</h2></div>
                <div class="space-y-3">${state.transactions.length === 0 ? '<div class="sys-panel p-8 text-center text-gray-400">å°šç„¡æ•¸æ“š</div>' : state.transactions.map(tx => renderTransactionItem(tx)).join('')}</div>
            `;
        };

        const renderTransactionItem = (tx) => {
            const isExpense = tx.type === 'expense'; const isTransfer = tx.type === 'transfer';
            const isPending = tx.type === 'income' && tx.isVerified === false;
            const isRealization = tx.type === 'transfer' && tx.isRealization === true;
            const isExcluded = tx.isExcluded === true;
            
            let icon = isExpense ? 'fa-arrow-trend-down' : (isTransfer ? 'fa-right-left' : 'fa-arrow-trend-up');
            let color = isExpense ? 'text-sys-danger' : (isTransfer ? 'text-sys-blue' : 'text-sys-success');
            
            if (isPending) { color = 'text-sys-warn'; icon = 'fa-clock'; }
            if (isRealization) { color = 'text-sys-success'; icon = 'fa-check-double'; }
            if (isExcluded) { color = 'text-gray-500'; icon = 'fa-ban'; }

            return `
                <div class="sys-panel p-4 flex justify-between items-center relative overflow-hidden group cursor-pointer hover:bg-sys-blue/5 transition-colors" onclick="openTransactionModal('${tx.id}')">
                    <div class="flex items-center gap-3 z-10">
                        <div class="w-10 h-10 flex items-center justify-center border border-sys-blue/50 bg-sys-blue/10 ${color}"><i class="fa-solid ${icon}"></i></div>
                        <div>
                            <div class="font-bold uppercase text-sm ${color}">
                                ${tx.category} 
                                ${isPending ? '(é æ”¶æš«å­˜)' : ''}
                                ${isRealization ? '(æ ¸éŠ·æ”¶å…¥)' : ''}
                                ${isExcluded ? '(ä¸åˆ—å…¥çµ±è¨ˆ)' : ''}
                            </div>
                            <div class="text-xs text-gray-400">${tx.date} | ${tx.note || 'ç„¡å‚™è¨»'}</div>
                        </div>
                    </div>
                    <div class="text-right z-10 flex flex-col items-end gap-2">
                        <span class="font-bold text-lg ${color}">${isExpense?'-':(isTransfer?'':'+')}${formatCurrency(tx.amount)}</span>
                        ${isTransfer ? `<span class="text-xs text-gray-500">${tx.accountFrom} &rarr; ${tx.accountTo}</span>` : ''}
                    </div>
                </div>`;
        };

        const renderSettings = (container) => {
            const accListHtml = state.accounts.map((acc, i) => `
                <div class="flex justify-between items-center p-3 bg-sys-blue/5 border border-sys-blue/20">
                    <span class="font-bold text-sm">${acc}</span>
                    <div class="flex items-center gap-2">
                        <button onclick="moveAccount(${i}, -1)" class="text-gray-500 hover:text-sys-blue ${i===0?'opacity-30 pointer-events-none':''}"><i class="fa-solid fa-arrow-up"></i></button>
                        <button onclick="moveAccount(${i}, 1)" class="text-gray-500 hover:text-sys-blue ${i===state.accounts.length-1?'opacity-30 pointer-events-none':''}"><i class="fa-solid fa-arrow-down"></i></button>
                        <button onclick="deleteMeta('account', '${acc}')" class="text-gray-500 hover:text-sys-danger ml-2"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <h2 class="text-xl font-bold text-sys-blue uppercase mb-6 tracking-widest">ç³»çµ±è¨­å®š & å·¥å…·</h2>
                <div class="sys-panel p-6 mb-6">
                    <h3 class="text-lg font-bold text-sys-blue uppercase mb-4"><i class="fa-solid fa-wallet mr-2"></i>å¸³æˆ¶ç®¡ç†</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-account-name-settings" placeholder="æ–°å¢å¸³æˆ¶åç¨±..." class="flex-1">
                        <button onclick="addAccountSettings()" class="sys-btn py-1 px-4"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2 space-y-1">
                        ${accListHtml}
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div onclick="openCatsModal()" class="sys-panel p-6 flex justify-between items-center cursor-pointer hover:border-sys-blue transition-all group">
                        <div><h3 class="text-lg font-bold text-sys-blue uppercase"><i class="fa-solid fa-tags mr-2"></i>åˆ†é¡æ¶æ§‹ç®¡ç†</h3><p class="text-xs text-gray-400">æ–°å¢ã€ç§»é™¤æˆ–æ’åºåˆ†é¡</p></div>
                        <i class="fa-solid fa-chevron-right text-sys-blue opacity-50 group-hover:opacity-100"></i>
                    </div>
                    <div onclick="openRulesModal()" class="sys-panel p-6 flex justify-between items-center cursor-pointer hover:border-sys-blue transition-all group">
                        <div><h3 class="text-lg font-bold text-sys-blue uppercase"><i class="fa-solid fa-robot mr-2"></i>è‡ªå‹•åˆ†é¡è¨˜æ†¶åº«</h3><p class="text-xs text-gray-400">ç®¡ç†é—œéµå­—è‡ªå‹•æ­¸é¡è¦å‰‡</p></div>
                        <i class="fa-solid fa-chevron-right text-sys-blue opacity-50 group-hover:opacity-100"></i>
                    </div>
                    <div onclick="toggleModal('modal-db')" class="sys-panel p-6 flex justify-between items-center cursor-pointer hover:border-sys-danger border-sys-danger/50 group">
                        <div><h3 class="text-lg font-bold text-sys-danger uppercase"><i class="fa-solid fa-shield-halved mr-2"></i>ç³»çµ±æ ¸å¿ƒè³‡æ–™åº«</h3><p class="text-xs text-gray-400">å‚™ä»½ã€é‚„åŸèˆ‡ç³»çµ±é‡ç½®</p></div>
                        <i class="fa-solid fa-chevron-right text-sys-danger opacity-50 group-hover:opacity-100"></i>
                    </div>
                    <div class="sys-panel p-6 border-t-4 border-sys-purple mt-4">
                        <h3 class="text-lg font-bold text-sys-purple uppercase mb-4"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>æ™ºèƒ½æ‰¹æ¬¡è§£æ</h3>
                        <textarea id="batch-input" rows="4" placeholder="è²¼ä¸Šæ–‡å­—ï¼Œå¦‚ï¼š&#10;12/25 Costcoé¤é£² 500 ä¿¡ç”¨å¡&#10;12/25 Costcoä»£å¢Š 1800 ä¿¡ç”¨å¡" class="w-full mb-4 font-mono text-sm"></textarea>
                        <button onclick="processBatch()" class="sys-btn w-full !border-sys-purple !text-sys-purple hover:!bg-sys-purple hover:!text-white">åŸ·è¡Œè§£æç¨‹åº</button>
                    </div>
                </div>
            `;
        };

        const addAccountSettings = () => {
            const val = document.getElementById('new-account-name-settings').value.trim();
            if(val && !state.accounts.includes(val)) {
                state.accounts.push(val);
                saveData();
            }
        };
        const deleteMeta = (type, val) => {
            if(confirm(`ç¢ºå®šåˆªé™¤ [${val}]?`)) {
                if(type === 'account') state.accounts = state.accounts.filter(a => a !== val);
                saveData();
            }
        };
        const moveAccount = (index, dir) => {
            if (dir === -1 && index > 0) {
                [state.accounts[index], state.accounts[index-1]] = [state.accounts[index-1], state.accounts[index]];
            } else if (dir === 1 && index < state.accounts.length - 1) {
                [state.accounts[index], state.accounts[index+1]] = [state.accounts[index+1], state.accounts[index]];
            }
            saveData();
        };

        const addCategory = () => {
            const val = document.getElementById('new-cat-name').value.trim();
            const type = state.ui.catManageType;
            if (val && !state.categories[type].includes(val)) {
                state.categories[type].push(val);
                document.getElementById('new-cat-name').value = '';
                saveData(); renderCatList();
            }
        };
        const deleteCategory = (type, val) => {
            if(confirm(`åˆªé™¤ [${val}]?`)) {
                state.categories[type] = state.categories[type].filter(c => c !== val);
                saveData(); renderCatList();
            }
        };
        const moveCategory = (index, dir) => {
            const type = state.ui.catManageType;
            if (dir === -1 && index > 0) {
                [state.categories[type][index], state.categories[type][index-1]] = [state.categories[type][index-1], state.categories[type][index]];
            } else if (dir === 1 && index < state.categories[type].length - 1) {
                [state.categories[type][index], state.categories[type][index+1]] = [state.categories[type][index+1], state.categories[type][index]];
            }
            saveData(); renderCatList();
        };

        const openRulesModal = () => { toggleModal('modal-rules'); renderRuleList(); };
        const renderRuleList = () => {
            const html = Object.keys(state.keywordMap).length === 0 ? '<p class="text-gray-400 text-sm">ç„¡è¦å‰‡</p>' : 
            Object.entries(state.keywordMap).map(([k, c]) => `
                <div class="flex justify-between items-center p-3 bg-sys-blue/5 border border-sys-blue/20">
                    <span class="text-sm">"${k}" &rarr; <strong class="text-sys-purple">${c}</strong></span>
                    <button onclick="deleteRule('${k}')" class="text-gray-500 hover:text-sys-danger"><i class="fa-solid fa-xmark"></i></button>
                </div>`).join('');
            document.getElementById('rule-list-container').innerHTML = html;
        };
        const deleteRule = (k) => { delete state.keywordMap[k]; saveData(); renderRuleList(); };

        const processBatch = () => {
            const text = document.getElementById('batch-input').value;
            if (!text) return;
            const lines = text.split('\n').filter(l => l.trim());
            let count = 0;
            lines.forEach(line => {
                const match = line.match(/(\d{4}-\d{2}-\d{2}|\d{1,2}\/\d{1,2})\s+(.+?)\s+(\d+(\.\d+)?)\s*(\S+)?\s*(\((æ”¶å…¥|income)\))?/i);
                if (match) {
                    let [_, dateStr, note, amount, , account, typeTag] = match;
                    let date = dateStr.includes('-') ? dateStr : `${new Date().getFullYear()}-${dateStr.replace('/', '-').padStart(5, '0')}`;
                    if(date.length < 10) date = date.replace(/-(\d)$/,"-0$1").replace(/-(\d)-/,"-0$1-"); 
                    const type = typeTag ? 'income' : 'expense';
                    let targetAcc = (account && state.accounts.includes(account)) ? account : state.accounts[0];
                    let cat = type === 'income' ? state.categories.income[0] : state.categories.expense[0];
                    for (const [k, c] of Object.entries(state.keywordMap)) { if (note.includes(k)) { cat = c; break; } }
                    
                    state.transactions.unshift({
                        id: Date.now().toString() + Math.random(),
                        date, type, amount: parseFloat(amount), category: cat, accountFrom: targetAcc, note, isVerified: true, isRealization: false
                    });
                    count++;
                }
            });
            document.getElementById('batch-input').value = '';
            saveData(); showSystemToast(`è§£æå®Œæˆ ${count} ç­†`);
        };
        const exportData = () => {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = `finsys_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };
        const importData = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if(confirm('ç¢ºå®šé‚„åŸï¼Ÿ')) { state = JSON.parse(ev.target.result); saveData(); location.reload(); }
            };
            reader.readAsText(file);
        };
        const resetData = () => { if(prompt('è¼¸å…¥RESETé‡ç½®')==='RESET') { localStorage.removeItem(APP_ID); location.reload(); } };

        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.classList.add('dark');
            loadData();
            state.ui.currentView = 'view-accounts'; 
            renderApp();
        });
    </script>
</body>
</html>