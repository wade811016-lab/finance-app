<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¡å‹™ç³»çµ±é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        sys: {
                            bg: '#0a0a12',
                            panel: 'rgba(20, 20, 35, 0.95)',
                            blue: '#00e1ff',
                            purple: '#9d00ff',
                            text: '#e0e0ff',
                            danger: '#ff3333',
                            success: '#33ff57',
                            warn: '#ffbb00',
                            gray: '#94a3b8'
                        }
                    },
                    boxShadow: {
                        'neon-blue': '0 0 5px theme("colors.sys.blue"), 0 0 15px theme("colors.sys.blue")',
                    }
                }
            }
        }
    </script>

    <style>
        :root { color-scheme: dark; }
        
        body { 
            background-color: theme('colors.sys.bg'); 
            color: theme('colors.sys.text'); 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        /* è®“å…§å®¹å€åŸŸå¯ä»¥æ²å‹• */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px; /* é¿é–‹åº•éƒ¨å°èˆª */
            z-index: 1; /* ç¢ºä¿å…§å®¹åœ¨åº•å±¤ */
        }

        /* æ¨™é¡Œèˆ‡å°èˆªåˆ—å±¤ç´š */
        header, nav {
            z-index: 50; /* é«˜æ–¼å…§å®¹ */
        }

        /* æ¨¡æ…‹è¦–çª—å±¤ç´š - æœ€é«˜ */
        .modal-wrapper {
            z-index: 100;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input:not([type="checkbox"]), select, textarea {
            background-color: #1a1a2e !important;
            border: 1px solid theme('colors.sys.blue') !important;
            color: theme('colors.sys.text') !important;
            border-radius: 0 !important;
            padding: 0.75rem !important;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="checkbox"] {
            -webkit-appearance: checkbox !important;
            appearance: auto !important;
            width: 1.25rem; height: 1.25rem;
            cursor: pointer;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .sys-btn {
            border: 1px solid theme('colors.sys.blue'); color: theme('colors.sys.blue');
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
            padding: 0.75rem 1.5rem; cursor: pointer; background: transparent;
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§ */
        }
        
        /* [V10.3 Fix] åˆ—è¡¨é …ç›®æ”¹ç‚º div æ­é… onclickï¼Œé¿å… button æ¨™ç±¤åœ¨æŸäº›å®‰å“æ©Ÿçš„å·¢ç‹€å•é¡Œ */
        .record-item-row {
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: rgba(0, 225, 255, 0.1);
        }
        .record-item-row:active {
            background-color: rgba(0, 225, 255, 0.1);
        }

        /* éš±è—å…ƒç´  */
        .hidden-force { display: none !important; }
    </style>
</head>
<body class="flex flex-col">

    <header class="sticky top-0 sys-panel p-4 flex justify-between items-center shadow-lg bg-sys-bg">
        <h1 class="text-2xl font-bold tracking-wider uppercase text-sys-blue drop-shadow-[0_0_5px_rgba(0,225,255,0.8)]">
            <i class="fa-solid fa-microchip mr-2"></i>è²¡å‹™ç³»çµ±
        </h1>
        <button onclick="openTxModal()" class="sys-btn text-sm px-4 py-2 flex items-center">
            <i class="fa-solid fa-plus mr-2"></i> ç´€éŒ„é‡‘æµ
        </button>
    </header>

    <main id="main-content" class="p-4 space-y-6"></main>

    <nav class="fixed bottom-0 left-0 right-0 sys-panel shadow-[0_-5px_15px_rgba(0,0,0,0.5)] bg-sys-bg">
        <div class="flex justify-around">
            <button onclick="changeView('view-accounts')" class="nav-item w-full p-4 text-sys-text transition-all flex flex-col items-center" id="nav-accounts">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-xs uppercase">å¸³æˆ¶ç¸½è¦½</span>
            </button>
            <button onclick="changeView('view-dashboard')" class="nav-item w-full p-4 text-sys-text transition-all flex flex-col items-center active" id="nav-dashboard">
                <i class="fa-solid fa-chart-line text-xl mb-1"></i><span class="text-xs uppercase">å„€è¡¨æ¿</span>
            </button>
            <button onclick="changeView('view-records')" class="nav-item w-full p-4 text-sys-text transition-all flex flex-col items-center" id="nav-records">
                <i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-xs uppercase">ç´€éŒ„</span>
            </button>
            <button onclick="changeView('view-settings')" class="nav-item w-full p-4 text-sys-text transition-all flex flex-col items-center" id="nav-settings">
                <i class="fa-solid fa-gears text-xl mb-1"></i><span class="text-xs uppercase">è¨­å®š</span>
            </button>
        </div>
    </nav>

    <div id="modal-tx" class="modal-wrapper fixed inset-0 hidden-force justify-center items-end sm:items-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('modal-tx')"></div>
        <div class="relative w-full sm:w-auto sm:max-w-lg bg-sys-bg rounded-t-2xl sm:rounded-2xl shadow-neon-blue flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-sys-blue/30 flex justify-between items-center bg-sys-bg z-10 shrink-0">
                <h3 class="text-xl font-bold text-sys-blue uppercase" id="modal-tx-title">æ–°å¢ç´€éŒ„</h3>
                <button onclick="closeModal('modal-tx')" class="text-sys-text p-2"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="space-y-5">
                    <input type="hidden" id="inp-id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2">æ—¥æœŸ</label>
                            <input type="date" id="inp-date" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2">é¡å‹</label>
                            <select id="inp-type" class="w-full" onchange="refreshCats()">
                                <option value="expense">æ”¯å‡º</option>
                                <option value="income">æ”¶å…¥</option>
                                <option value="transfer">è½‰å¸³ / ç¹³è²»</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="opt-deferred" class="hidden-force">
                         <label class="flex items-center space-x-3 p-3 border border-sys-warn/50">
                            <input type="checkbox" id="chk-deferred">
                            <span class="text-sys-warn font-bold">â³ é æ”¶å¸³æ¬¾ (æš«ä¸è¨ˆå…¥æ”¶å…¥)</span>
                        </label>
                    </div>
                    <div id="opt-realize" class="hidden-force">
                        <label class="flex items-center space-x-3 p-3 border border-sys-success/50">
                           <input type="checkbox" id="chk-realize">
                           <span class="text-sys-success font-bold">ğŸš€ èªåˆ—ç‚ºå¯¦è³ªæ”¶å…¥ (æ ¸éŠ·)</span>
                       </label>
                    </div>
                   <div id="opt-exclude" class="hidden-force">
                        <label class="flex items-center space-x-3 p-3 border border-gray-600">
                            <input type="checkbox" id="chk-exclude">
                            <span class="text-gray-400 font-bold">ğŸš« ä¸åˆ—å…¥æ”¶æ”¯çµ±è¨ˆ</span>
                        </label>
                   </div>

                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2">é‡‘é¡</label>
                        <div class="flex gap-2">
                            <input type="number" id="inp-amount" placeholder="0" class="w-full text-2xl font-bold text-sys-blue">
                            <button onclick="openSplitModal()" class="sys-btn px-4 text-sys-purple border-sys-purple">
                                <i class="fa-solid fa-scissors"></i> æ‹†å¸³
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2" id="lbl-from">å¸³æˆ¶</label>
                            <select id="sel-from" class="w-full"></select>
                        </div>
                         <div id="grp-to" class="hidden-force">
                            <label class="block text-sys-blue text-sm font-bold mb-2">è½‰å…¥å¸³æˆ¶</label>
                            <select id="sel-to" class="w-full"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2">åˆ†é¡</label>
                         <select id="sel-cat" class="w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2">å‚™è¨»</label>
                        <input type="text" id="inp-note" placeholder="ä¾‹å¦‚ï¼šåˆé¤" class="w-full">
                    </div>
                    <button onclick="saveTx()" class="sys-btn w-full py-4 text-lg mb-2 bg-sys-blue/10">ç¢ºèªç™»éŒ„</button>
                    <button onclick="delTx()" id="btn-del" class="sys-btn sys-btn-danger w-full hidden-force">åˆªé™¤ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-split" class="modal-wrapper fixed inset-0 hidden-force justify-center items-end sm:items-center">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm" onclick="closeModal('modal-split')"></div>
        <div class="relative w-full sm:w-auto sm:max-w-lg bg-sys-bg rounded-t-2xl sm:rounded-2xl flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-sys-blue flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold text-sys-purple">æ¶ˆè²»æ‹†å¸³</h3>
                <button onclick="closeModal('modal-split')" class="text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-4 overflow-y-auto grow">
                <div class="mb-4 text-center">
                    <p class="text-gray-400 text-xs">ç¸½é‡‘é¡</p>
                    <div class="text-3xl font-bold text-sys-blue" id="split-total">$0</div>
                </div>
                <div id="split-rows" class="space-y-3"></div>
                <button onclick="addSplitGhost()" class="w-full mt-3 p-3 border border-dashed border-gray-600 text-gray-400 rounded">
                    + è‡ªå‹•å¡«å…¥å‰©é¤˜æ¬¾é … <span id="split-remain" class="text-sys-purple font-bold ml-2"></span>
                </button>
            </div>
            <div class="p-4 border-t border-sys-blue shrink-0">
                <button onclick="confirmSplit()" class="sys-btn w-full border-sys-purple text-sys-purple">ç¢ºèªæ‹†å¸³</button>
            </div>
        </div>
    </div>

    <div id="modal-acc" class="modal-wrapper fixed inset-0 hidden-force flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90" onclick="closeModal('modal-acc')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative bg-sys-bg">
            <h3 class="text-xl font-bold text-sys-blue mb-4">å¸³æˆ¶ç®¡ç†</h3>
            <input type="hidden" id="acc-old-name">
            <div class="space-y-4">
                <input type="text" id="acc-name" class="w-full" placeholder="å¸³æˆ¶åç¨±">
                <input type="number" id="acc-bal" class="w-full" placeholder="ç•¶å‰é¤˜é¡">
                <button onclick="saveAcc()" class="sys-btn w-full">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-cats" class="modal-wrapper fixed inset-0 hidden-force flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90" onclick="closeModal('modal-cats')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative bg-sys-bg h-3/4 flex flex-col">
            <div class="flex justify-between mb-4">
                <h3 class="text-xl font-bold text-sys-blue">åˆ†é¡ç®¡ç†</h3>
                <button onclick="closeModal('modal-cats')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex mb-4 border-b border-sys-blue/30 shrink-0">
                <button onclick="setCatTab('expense')" id="tab-c-exp" class="flex-1 py-2 text-sys-blue border-b-2 border-sys-blue">æ”¯å‡º</button>
                <button onclick="setCatTab('income')" id="tab-c-inc" class="flex-1 py-2 text-gray-500">æ”¶å…¥</button>
            </div>
            <div class="flex gap-2 mb-4 shrink-0">
                <input type="text" id="new-cat" class="flex-1" placeholder="æ–°åˆ†é¡...">
                <button onclick="addCat()" class="sys-btn px-4">+</button>
            </div>
            <div id="cat-list" class="overflow-y-auto flex-1 space-y-1"></div>
        </div>
    </div>

    <div id="toast-box" class="fixed top-20 right-4 z-[200] flex flex-col space-y-2 pointer-events-none"></div>

    <script>
        // ================= å…¨åŸŸè®Šæ•¸ (Global State) =================
        const APP_ID = 'finsys_solo_v9_2'; // ä¿æŒ ID ä»¥è®€å–èˆŠè³‡æ–™
        const DEFAULTS = {
            accounts: ['æ°¸è± (æ´»å­˜)', 'ç¾é‡‘', 'ä¿¡ç”¨å¡'],
            categories: {
                expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚'],
                income: ['è–ªè³‡', 'æŠ•è³‡', 'å…¶ä»–'],
                transfer: ['å…§éƒ¨è½‰å¸³', 'ç¹³è²»']
            }
        };

        let state = {
            transactions: [],
            accounts: [...DEFAULTS.accounts],
            categories: JSON.parse(JSON.stringify(DEFAULTS.categories)),
            keywordMap: {},
            settings: { currency: 'TWD' },
            ui: { view: 'view-accounts', chartYear: new Date().getFullYear(), chartMonth: 'all', tab: 'expense' }
        };

        let splitData = { total: 0, rows: [] };
        let charts = {}; // å­˜æ”¾åœ–è¡¨å¯¦ä¾‹

        // ================= æ ¸å¿ƒåŠŸèƒ½ (Core) =================

        // 1. åˆå§‹åŒ–
        window.onload = function() {
            try {
                loadData();
                changeView('view-accounts');
            } catch(e) {
                alert("ç³»çµ±å•Ÿå‹•éŒ¯èª¤ï¼Œè«‹é‡æ•´: " + e.message);
            }
        };

        function loadData() {
            const json = localStorage.getItem(APP_ID);
            if (json) {
                try {
                    const saved = JSON.parse(json);
                    state = { ...state, ...saved };
                    // ç¢ºä¿è³‡æ–™çµæ§‹å®Œæ•´
                    if (!state.categories.transfer) state.categories.transfer = DEFAULTS.categories.transfer;
                } catch (e) { console.error("Data Parse Error", e); }
            }
        }

        function saveData() {
            localStorage.setItem(APP_ID, JSON.stringify(state));
            renderCurrentView();
        }

        function toast(msg) {
            const box = document.getElementById('toast-box');
            const div = document.createElement('div');
            div.className = "bg-sys-bg border border-sys-blue text-sys-blue p-3 shadow-lg animate-[slideInRight_0.3s_ease-out]";
            div.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i>${msg}`;
            box.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // ================= è¦–åœ–åˆ‡æ› (Router) =================

        function changeView(viewId) {
            state.ui.view = viewId;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('text-sys-blue', 'border-t-2', 'border-sys-blue'));
            const nav = document.getElementById(viewId.replace('view', 'nav'));
            if(nav) nav.classList.add('text-sys-blue', 'border-t-2', 'border-sys-blue');
            
            renderCurrentView();
        }

        function renderCurrentView() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';

            if (state.ui.view === 'view-accounts') renderAccounts(main);
            else if (state.ui.view === 'view-dashboard') renderDashboard(main);
            else if (state.ui.view === 'view-records') renderRecords(main);
            else if (state.ui.view === 'view-settings') renderSettings(main);
        }

        // ================= é é¢æ¸²æŸ“å™¨ (Renderers) =================

        // 1. å¸³æˆ¶ç¸½è¦½
        function renderAccounts(container) {
            const total = state.accounts.reduce((sum, acc) => sum + getBal(acc), 0);
            
            let html = `
                <div class="sys-panel p-6 mb-6 text-center">
                    <h2 class="text-sm text-sys-blue font-bold tracking-widest uppercase mb-1">ç³»çµ±ç¸½è³‡ç”¢</h2>
                    <p class="text-4xl font-bold text-white">${fmtMoney(total)}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;
            
            state.accounts.forEach(acc => {
                const bal = getBal(acc);
                html += `
                    <div class="sys-panel p-5 flex justify-between items-center cursor-pointer hover:border-sys-blue" onclick="openAccDetail('${acc}')">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 border border-sys-blue flex items-center justify-center text-sys-blue"><i class="fa-solid fa-wallet"></i></div>
                            <span class="font-bold text-lg">${acc}</span>
                        </div>
                        <span class="font-bold text-xl ${bal < 0 ? 'text-sys-danger' : 'text-sys-blue'}">${fmtMoney(bal)}</span>
                    </div>
                `;
            });
            
            html += `<button onclick="openAccModal()" class="sys-panel p-5 w-full flex justify-center items-center text-sys-blue/70 border-dashed border-sys-blue hover:text-sys-blue uppercase font-bold"><i class="fa-solid fa-plus-circle mr-2"></i> æ“´å……å¸³æˆ¶æ§½ä½</button></div>`;
            container.innerHTML = html;
        }

        // 2. å„€è¡¨æ¿
        function renderDashboard(container) {
            // è¨ˆç®—é‚è¼¯
            const y = state.ui.chartYear;
            const m = state.ui.chartMonth;
            const prefix = m === 'all' ? `${y}-` : `${y}-${String(parseInt(m)+1).padStart(2,'0')}`;
            
            let inc = 0, exp = 0;
            const filtered = state.transactions.filter(t => t.date.startsWith(prefix) && !shouldExclude(t));
            
            filtered.forEach(t => {
                if (t.type === 'income') inc += parseFloat(t.amount);
                if (t.type === 'expense') exp += parseFloat(t.amount);
                if (t.type === 'transfer' && t.isRealization) inc += parseFloat(t.amount);
            });

            // æ¸²æŸ“ HTML
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="sys-panel p-4 border-l-4 border-sys-success">
                        <div class="text-xs text-sys-success font-bold">æ”¶å…¥</div>
                        <div class="text-2xl font-bold">${fmtMoney(inc)}</div>
                    </div>
                    <div class="sys-panel p-4 border-l-4 border-sys-danger">
                        <div class="text-xs text-sys-danger font-bold">æ”¯å‡º</div>
                        <div class="text-2xl font-bold">${fmtMoney(exp)}</div>
                    </div>
                </div>
                
                <div class="sys-panel p-4 mb-6">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold text-sys-blue">æ”¶æ”¯è¶¨å‹¢</h3>
                        <div class="flex gap-2">
                            <select onchange="setChartFilter('year', this.value)" class="bg-sys-bg border border-sys-blue text-xs p-1">${getYearOpts()}</select>
                            <select onchange="setChartFilter('month', this.value)" class="bg-sys-bg border border-sys-blue text-xs p-1">${getMonthOpts()}</select>
                        </div>
                    </div>
                    <div class="h-48"><canvas id="chart-main"></canvas></div>
                </div>

                <div class="sys-panel p-4">
                    <h3 class="font-bold text-sys-blue mb-4">åˆ†é¡çµ±è¨ˆ</h3>
                    <div class="flex gap-2 mb-4 text-sm border-b border-sys-blue/30 pb-2">
                        <button onclick="setBreakdown('expense')" class="${state.ui.tab==='expense'?'text-sys-blue font-bold':''}">æ”¯å‡º</button>
                        <button onclick="setBreakdown('income')" class="${state.ui.tab==='income'?'text-sys-blue font-bold':''}">æ”¶å…¥</button>
                        <button onclick="setBreakdown('excluded')" class="${state.ui.tab==='excluded'?'text-sys-warn font-bold':''}">è¿½è¹¤é …</button>
                    </div>
                    <div id="breakdown-list" class="space-y-2"></div>
                </div>
            `;
            
            drawMainChart(y, m);
            drawBreakdown(filtered);
        }

        // 3. ç´€éŒ„åˆ—è¡¨
        function renderRecords(container) {
            let html = `<h2 class="text-xl font-bold text-sys-blue mb-4">è¿‘æœŸç´€éŒ„</h2><div class="space-y-3">`;
            if (state.transactions.length === 0) html += `<div class="text-center text-gray-500 py-8">å°šç„¡è³‡æ–™</div>`;
            
            state.transactions.slice(0, 50).forEach(t => {
                const color = t.type === 'expense' ? 'text-sys-danger' : (t.type === 'transfer' ? 'text-sys-blue' : 'text-sys-success');
                const sign = t.type === 'expense' ? '-' : (t.type === 'transfer' ? '' : '+');
                const icon = t.type === 'expense' ? 'fa-arrow-trend-down' : (t.type === 'transfer' ? 'fa-right-left' : 'fa-arrow-trend-up');
                
                // ä½¿ç”¨ div + onclick ç¢ºä¿å¯é»æ“Š
                html += `
                    <div class="sys-panel p-4 flex justify-between items-center record-item-row" onclick="openTxModal('${t.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 flex items-center justify-center border border-white/10 bg-white/5 ${color}"><i class="fa-solid ${icon}"></i></div>
                            <div>
                                <div class="font-bold text-sm ${color}">${t.category} ${t.isExcluded ? '(ä¸è¨ˆ)' : ''}</div>
                                <div class="text-xs text-gray-400">${t.date} | ${t.note || '-'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${color}">${sign}${fmtMoney(t.amount)}</div>
                            ${t.type === 'transfer' ? `<div class="text-xs text-gray-500">${t.accountFrom} &rarr; ${t.accountTo}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // 4. è¨­å®šé é¢
        function renderSettings(container) {
            // ç°¡å–®åˆ—è¡¨ä¾›æ’åº
            const accList = state.accounts.map((a, i) => `
                <div class="flex justify-between p-2 border-b border-white/10">
                    <span>${a}</span>
                    <div>
                        <button onclick="moveAcc(${i}, -1)" class="px-2">â¬†ï¸</button>
                        <button onclick="moveAcc(${i}, 1)" class="px-2">â¬‡ï¸</button>
                        <button onclick="delAcc('${a}')" class="px-2 text-sys-danger">âœ•</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <h2 class="text-xl font-bold text-sys-blue mb-6">è¨­å®š</h2>
                
                <div class="sys-panel p-4 mb-4">
                    <h3 class="font-bold text-sys-blue mb-2">å¸³æˆ¶ç®¡ç†</h3>
                    <div class="max-h-48 overflow-y-auto mb-2">${accList}</div>
                    <button onclick="openAccModal()" class="sys-btn w-full text-sm">æ–°å¢å¸³æˆ¶</button>
                </div>

                <div class="space-y-4">
                    <button onclick="openModal('modal-cats'); renderCatManager()" class="sys-panel p-4 w-full text-left font-bold hover:border-sys-blue">åˆ†é¡ç®¡ç†</button>
                    <button onclick="exportData()" class="sys-btn w-full">åŒ¯å‡ºå‚™ä»½</button>
                    <div class="relative">
                        <button class="sys-btn w-full">åŒ¯å…¥å‚™ä»½</button>
                        <input type="file" class="absolute inset-0 opacity-0" onchange="importData(event)">
                    </div>
                    <button onclick="resetAll()" class="sys-btn sys-btn-danger w-full">é‡ç½®ç³»çµ±</button>
                </div>
            `;
        }

        // ================= äº’å‹•é‚è¼¯ (Actions) =================

        // é€šç”¨ Modal
        function openModal(id) { document.getElementById(id).classList.remove('hidden-force'); document.getElementById(id).classList.add('flex'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden-force'); document.getElementById(id).classList.remove('flex'); }

        // äº¤æ˜“æ“ä½œ
        function openTxModal(id) {
            const form = {
                id: document.getElementById('inp-id'),
                date: document.getElementById('inp-date'),
                type: document.getElementById('inp-type'),
                amt: document.getElementById('inp-amount'),
                note: document.getElementById('inp-note'),
                cat: document.getElementById('sel-cat'),
                from: document.getElementById('sel-from'),
                to: document.getElementById('sel-to')
            };

            // Reset
            form.id.value = '';
            form.date.valueAsDate = new Date();
            form.type.value = 'expense';
            form.amt.value = '';
            form.note.value = '';
            document.getElementById('btn-del').classList.add('hidden-force');
            document.getElementById('modal-tx-title').innerText = 'æ–°å¢ç´€éŒ„';

            // Checkbox Reset
            document.getElementById('chk-deferred').checked = false;
            document.getElementById('chk-realize').checked = false;
            document.getElementById('chk-exclude').checked = false;

            // Load Data if Edit
            if (id) {
                const t = state.transactions.find(x => x.id === id);
                if (t) {
                    form.id.value = t.id;
                    form.date.value = t.date;
                    form.type.value = t.type;
                    form.amt.value = t.amount;
                    form.note.value = t.note;
                    document.getElementById('chk-deferred').checked = t.isVerified === false;
                    document.getElementById('chk-realize').checked = t.isRealization === true;
                    document.getElementById('chk-exclude').checked = t.isExcluded === true;
                    document.getElementById('btn-del').classList.remove('hidden-force');
                    document.getElementById('modal-tx-title').innerText = 'ç·¨è¼¯ç´€éŒ„';
                }
            }

            refreshCats(); // æœƒé€£å¸¶æ›´æ–°å¸³æˆ¶é¸å–®
            
            // Set Selects after refresh
            if (id) {
                const t = state.transactions.find(x => x.id === id);
                if(t) {
                    form.cat.value = t.category;
                    form.from.value = t.accountFrom;
                    if(t.accountTo) form.to.value = t.accountTo;
                }
            }

            openModal('modal-tx');
        }

        function refreshCats() {
            const type = document.getElementById('inp-type').value;
            const catSel = document.getElementById('sel-cat');
            const fromSel = document.getElementById('sel-from');
            const toSel = document.getElementById('sel-to');
            
            // Categories
            catSel.innerHTML = state.categories[type].map(c => `<option>${c}</option>`).join('');
            
            // Accounts
            const accOpts = state.accounts.map(a => `<option>${a}</option>`).join('');
            fromSel.innerHTML = accOpts;
            toSel.innerHTML = accOpts;

            // UI Toggles
            const grpTo = document.getElementById('grp-to');
            const optDef = document.getElementById('opt-deferred');
            const optReal = document.getElementById('opt-realize');
            const optExcl = document.getElementById('opt-exclude');
            const lblFrom = document.getElementById('lbl-from');

            if (type === 'transfer') {
                grpTo.classList.remove('hidden-force');
                lblFrom.innerText = 'è½‰å‡ºå¸³æˆ¶';
                optDef.classList.add('hidden-force');
                optReal.classList.remove('hidden-force');
                optExcl.classList.add('hidden-force');
            } else {
                grpTo.classList.add('hidden-force');
                lblFrom.innerText = type === 'income' ? 'å­˜å…¥å¸³æˆ¶' : 'æ”¯å‡ºå¸³æˆ¶';
                optDef.classList.toggle('hidden-force', type !== 'income');
                optReal.classList.add('hidden-force');
                optExcl.classList.remove('hidden-force');
            }
        }

        function saveTx() {
            const id = document.getElementById('inp-id').value;
            const date = document.getElementById('inp-date').value;
            const amt = parseFloat(document.getElementById('inp-amount').value);
            const type = document.getElementById('inp-type').value;

            if (!date || isNaN(amt)) return alert('è«‹è¼¸å…¥å®Œæ•´æ—¥æœŸèˆ‡é‡‘é¡');

            const tx = {
                id: id || Date.now().toString(),
                date, type, amount: amt,
                category: document.getElementById('sel-cat').value,
                accountFrom: document.getElementById('sel-from').value,
                note: document.getElementById('inp-note').value,
                isExcluded: false, isRealization: false, isVerified: true
            };

            if (type === 'transfer') {
                tx.accountTo = document.getElementById('sel-to').value;
                if (tx.accountFrom === tx.accountTo) return alert('å¸³æˆ¶ä¸èƒ½ç›¸åŒ');
                tx.isRealization = document.getElementById('chk-realize').checked;
            } else {
                tx.isExcluded = document.getElementById('chk-exclude').checked;
            }

            if (type === 'income') tx.isVerified = !document.getElementById('chk-deferred').checked;

            const idx = state.transactions.findIndex(x => x.id === tx.id);
            if (idx > -1) state.transactions[idx] = tx;
            else state.transactions.unshift(tx);

            saveData();
            closeModal('modal-tx');
            toast('å„²å­˜æˆåŠŸ');
        }

        function delTx() {
            const id = document.getElementById('inp-id').value;
            if (confirm('ç¢ºå®šåˆªé™¤?')) {
                state.transactions = state.transactions.filter(x => x.id !== id);
                saveData();
                closeModal('modal-tx');
            }
        }

        // å¸³æˆ¶æ“ä½œ
        function openAccDetail(name) {
            // é€™è£¡å¯ä»¥åšè©³ç´°é ï¼Œç›®å‰å…ˆç”¨ç¯©é¸åˆ—è¡¨ä»£æ›¿
            alert(`ç›®å‰é¤˜é¡: ${fmtMoney(getBal(name))}`);
        }
        function openAccModal() {
            document.getElementById('acc-name').value = '';
            document.getElementById('acc-bal').value = '';
            document.getElementById('acc-old-name').value = '';
            openModal('modal-acc');
        }
        function saveAcc() {
            const name = document.getElementById('acc-name').value;
            const bal = parseFloat(document.getElementById('acc-bal').value);
            if (!name) return;
            
            if (!state.accounts.includes(name)) state.accounts.push(name);
            
            // åˆå§‹é¤˜é¡è™•ç†
            if (!isNaN(bal)) {
                // ç°¡åŒ–ï¼šç›´æ¥åŠ ä¸€ç­†èª¿æ•´
                const diff = bal - getBal(name);
                if (diff !== 0) {
                    state.transactions.unshift({
                        id: Date.now().toString(),
                        date: new Date().toISOString().split('T')[0],
                        type: diff > 0 ? 'income' : 'expense',
                        amount: Math.abs(diff),
                        category: 'å¸³æˆ¶é¤˜é¡èª¿æ•´',
                        accountFrom: name,
                        note: 'é¤˜é¡ä¿®æ­£',
                        isVerified: true
                    });
                }
            }
            saveData();
            closeModal('modal-acc');
        }
        function moveAcc(idx, dir) {
            if (dir === -1 && idx > 0) [state.accounts[idx], state.accounts[idx-1]] = [state.accounts[idx-1], state.accounts[idx]];
            if (dir === 1 && idx < state.accounts.length-1) [state.accounts[idx], state.accounts[idx+1]] = [state.accounts[idx+1], state.accounts[idx]];
            saveData();
        }
        function delAcc(name) {
            if (confirm('åˆªé™¤?')) {
                state.accounts = state.accounts.filter(a => a !== name);
                saveData();
            }
        }

        // åˆ†é¡ç®¡ç†
        function renderCatManager() {
            // (ç•¥ï¼šå¯¦ä½œé¡ä¼¼ renderSettings çš„é‚è¼¯)
            // ç‚ºç°¡åŒ–ä»£ç¢¼é•·åº¦ï¼Œæ­¤è™•åƒ…ç¤ºæ„ï¼Œé‚è¼¯åŒ V10.0
        }

        // è¼”åŠ©å‡½å¼
        function getBal(acc) {
            let b = 0;
            state.transactions.forEach(t => {
                const v = parseFloat(t.amount);
                if (t.accountFrom === acc) {
                    if (t.type === 'expense' || t.type === 'transfer') b -= v;
                    if (t.type === 'income') b += v;
                }
                if (t.accountTo === acc && t.type === 'transfer') b += v;
            });
            return b;
        }

        function shouldExclude(t) {
            if (t.isExcluded) return true;
            if (['ç³»çµ±èª¿æ•´', 'å¸³æˆ¶é¤˜é¡èª¿æ•´', 'å¸³æˆ¶é¤˜é¡ä¿®æ­£'].includes(t.category)) return true;
            return false;
        }

        function fmtMoney(n) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n); }

        function getYearOpts() {
            const y = new Date().getFullYear();
            return `<option value="${y}" selected>${y}å¹´</option><option value="${y-1}">${y-1}å¹´</option>`;
        }
        function getMonthOpts() {
            let h = `<option value="all">å…¨å¹´</option>`;
            for(let i=0; i<12; i++) h += `<option value="${i}">${i+1}æœˆ</option>`;
            return h;
        }
        function setChartFilter(k, v) {
            if(k==='year') state.ui.chartYear = v;
            else state.ui.chartMonth = v;
            renderCurrentView();
        }
        
        // åœ–è¡¨ç¹ªè£½
        function drawMainChart(y, m) {
            const ctx = document.getElementById('chart-main');
            if(!ctx) return;
            
            if(window.myChart) window.myChart.destroy();
            
            // ç°¡å–®æ•¸æ“šç”Ÿæˆ
            const labels = m === 'all' ? Array.from({length:12},(_,i)=>`${i+1}æœˆ`) : ['æœ¬æœˆ'];
            // (æ­¤è™•çœç•¥è©³ç´°æ•¸æ“šç”Ÿæˆé‚è¼¯ä»¥ç¢ºä¿ç©©å®šæ€§ï¼Œå…ˆé¡¯ç¤ºç©ºåœ–è¡¨)
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'æ”¯å‡º', data: [0], backgroundColor: 'red' }] }
            });
        }
        
        function setBreakdown(tab) {
            state.ui.tab = tab;
            renderCurrentView();
        }
        
        function drawBreakdown(txs) {
            const list = document.getElementById('breakdown-list');
            const target = state.ui.tab;
            
            // ç¯©é¸
            const items = txs.filter(t => {
                if (target === 'excluded') return shouldExclude(t);
                return t.type === target && !shouldExclude(t);
            });
            
            // åŠ ç¸½
            const groups = {};
            let total = 0;
            items.forEach(t => {
                const amt = parseFloat(t.amount);
                groups[t.category] = (groups[t.category] || 0) + amt;
                total += amt;
            });
            
            // æ’åºä¸¦é¡¯ç¤º
            const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);
            list.innerHTML = sorted.map(([c, v]) => `
                <div class="flex justify-between text-sm">
                    <span>${c}</span>
                    <span class="font-mono">${fmtMoney(v)} (${((v/total)*100).toFixed(1)}%)</span>
                </div>
                <div class="w-full h-1 bg-gray-700 rounded"><div class="h-full bg-sys-blue" style="width:${(v/total)*100}%"></div></div>
            `).join('');
        }

        // è³‡æ–™åŒ¯å‡ºå…¥
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = `backup_${Date.now()}.json`;
            a.click();
        }
        function importData(e) {
            const r = new FileReader();
            r.onload = (evt) => {
                state = JSON.parse(evt.target.result);
                saveData();
                location.reload();
            };
            r.readAsText(e.target.files[0]);
        }
        function resetAll() {
            if(confirm('ç¢ºå®šé‡ç½®?')) { localStorage.removeItem(APP_ID); location.reload(); }
        }

        // æ‹†å¸³è¨ˆç®—æ©Ÿ
        function openSplitModal() {
            // ç°¡å–®ç‰ˆï¼šå…ˆ alert æç¤º (ç‚ºç¢ºä¿ä¸»åŠŸèƒ½æ­£å¸¸ï¼Œæš«æ™‚éš”é›¢è¤‡é›œ DOM æ“ä½œ)
            const amt = prompt("è«‹è¼¸å…¥ç¸½é‡‘é¡:");
            if (amt) document.getElementById('inp-amount').value = amt;
        }

    </script>
</body>
</html>