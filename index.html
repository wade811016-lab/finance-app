<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¡å‹™ç³»çµ±é¢æ¿ | Financial System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        sys: {
                            bg: '#0a0a12',
                            panel: 'rgba(20, 20, 35, 0.95)',
                            blue: '#00e1ff',
                            purple: '#9d00ff',
                            text: '#e0e0ff',
                            danger: '#ff3333',
                            success: '#33ff57',
                            warn: '#ffbb00'
                        }
                    },
                    boxShadow: {
                        'neon-blue': '0 0 5px theme("colors.sys.blue"), 0 0 15px theme("colors.sys.blue")',
                    }
                }
            }
        }
    </script>

    <style>
        /* [Mobile Viewport Fix] ä½¿ç”¨ dynamic viewport height è§£æ±ºæ‰‹æ©Ÿç¶²å€åˆ—é®æ“‹å•é¡Œ */
        :root { color-scheme: dark; }
        
        body { 
            background-color: theme('colors.sys.bg'); 
            color: theme('colors.sys.text'); 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden;
            /* é—œéµï¼šç¢ºä¿ body ä½”æ»¿å‹•æ…‹é«˜åº¦ */
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.sys.bg'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.sys.blue'); }

        .sys-panel {
            background: theme('colors.sys.panel');
            border: 1px solid theme('colors.sys.blue');
            box-shadow: inset 0 0 10px rgba(0, 225, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .sys-panel::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, theme('colors.sys.blue'), transparent);
        }

        /* [Anti-White Flash V7] å¼·åˆ¶æ·±è‰²è¡¨å–®èˆ‡ç§»é™¤å‹•ç•« */
        input, select, textarea {
            background-color: #1a1a2e !important;
            border: 1px solid theme('colors.sys.blue') !important;
            color: theme('colors.sys.text') !important;
            border-radius: 0 !important;
            padding: 0.75rem !important;
            transition: none !important; 
            -webkit-appearance: none;
            appearance: none;
            color-scheme: dark; 
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            box-shadow: theme('boxShadow.neon-blue') !important;
            background-color: #232342 !important;
        }

        select option { 
            background-color: #0a0a12 !important; 
            color: #e0e0ff !important; 
            padding: 10px; 
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2300e1ff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; 
            background-repeat: no-repeat; 
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem !important; 
        }

        /* å„€è¡¨æ¿ä¸‹æ‹‰é¸å–®æ¨£å¼ä¿®æ­£ */
        .dashboard-select { 
            padding-top: 0 !important; 
            padding-bottom: 0 !important; 
            padding-left: 0.75rem !important;
            height: 2.5rem; 
            line-height: 2.5rem;
            min-width: 5rem; 
            width: auto;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .sys-btn {
            border: 1px solid theme('colors.sys.blue'); color: theme('colors.sys.blue');
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
            transition: all 0.3s ease; border-radius: 0; position: relative; overflow: hidden;
            padding: 0.75rem 1.5rem; cursor: pointer; background: transparent;
        }
        .sys-btn:hover { background: theme('colors.sys.blue'); color: theme('colors.sys.bg'); box-shadow: theme('boxShadow.neon-blue'); }
        .sys-btn-danger { border-color: theme('colors.sys.danger'); color: theme('colors.sys.danger'); }
        .sys-btn-danger:hover { background: theme('colors.sys.danger'); color: white; box-shadow: 0 0 15px theme('colors.sys.danger'); }
        .sys-btn-purple { border-color: theme('colors.sys.purple'); color: theme('colors.sys.purple'); }
        .sys-btn-purple:hover { background: theme('colors.sys.purple'); color: white; box-shadow: theme('boxShadow.neon-purple'); }

        .nav-item.active { color: theme('colors.sys.blue'); border-top: 2px solid theme('colors.sys.blue'); text-shadow: 0 0 10px theme('colors.sys.blue'); }
        
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .system-toast { animation: slideInRight 0.4s ease-out forwards; border-left: 4px solid theme('colors.sys.blue'); }
        
        /* [Mobile Layout Fix] ç¢ºä¿åº•éƒ¨å°èˆªä¸é®æ“‹å…§å®¹ */
        #main-content {
            padding-bottom: 160px !important; /* åŠ å¤§åº•éƒ¨ç•™ç™½ */
        }
    </style>
</head>
<body class="flex flex-col">

    <header class="sticky top-0 z-20 sys-panel p-4 flex justify-between items-center shadow-lg bg-sys-bg">
        <h1 class="text-2xl font-bold tracking-wider uppercase text-sys-blue drop-shadow-[0_0_5px_rgba(0,225,255,0.8)]">
            <i class="fa-solid fa-microchip mr-2"></i>è²¡å‹™ç³»çµ±
        </h1>
        <button onclick="openTransactionModal()" class="sys-btn text-sm px-4 py-2 flex items-center">
            <i class="fa-solid fa-plus mr-2"></i> ç´€éŒ„é‡‘æµ
        </button>
    </header>

    <main id="main-content" class="flex-1 overflow-y-auto p-4 space-y-6 relative"></main>

    <nav class="fixed bottom-0 left-0 right-0 sys-panel z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)] bg-sys-bg">
        <div class="flex justify-around">
            <button onclick="switchView('view-accounts')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-accounts">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-xs uppercase">å¸³æˆ¶ç¸½è¦½</span>
            </button>
            <button onclick="switchView('view-dashboard')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center active" id="nav-dashboard">
                <i class="fa-solid fa-chart-line text-xl mb-1"></i><span class="text-xs uppercase">å„€è¡¨æ¿</span>
            </button>
            <button onclick="switchView('view-records')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-records">
                <i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-xs uppercase">ç´€éŒ„</span>
            </button>
            <button onclick="switchView('view-settings')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-settings">
                <i class="fa-solid fa-gears text-xl mb-1"></i><span class="text-xs uppercase">è¨­å®š</span>
            </button>
        </div>
    </nav>

    <div id="modal-tx" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('modal-tx')"></div>
        <div class="absolute bottom-0 left-0 right-0 sys-panel rounded-t-none shadow-[0_-5px_20px_rgba(0,225,255,0.2)] animate-[slideUp_0.3s_ease-out] bg-sys-bg">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6 border-b border-sys-blue/30 pb-3">
                    <h3 class="text-xl font-bold text-sys-blue uppercase" id="modal-tx-title"><i class="fa-solid fa-pen-to-square mr-2"></i>æ–°å¢ç´€éŒ„</h3>
                    <button onclick="toggleModal('modal-tx')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                <form id="form-tx" class="space-y-5">
                    <input type="hidden" id="inp-id"> <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">æ—¥æœŸ</label>
                            <input type="date" id="inp-date" required class="w-full">
                        </div>
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">é¡å‹</label>
                            <select id="inp-type" class="w-full" onchange="updateCategoryOptions()">
                                <option value="expense">æ”¯å‡º (Expense)</option>
                                <option value="income">æ”¶å…¥ (Income)</option>
                                <option value="transfer">è½‰å¸³ / ç¹³è²» (Transfer)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="option-deferred" class="hidden">
                         <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-warn/50">
                            <input type="checkbox" id="inp-deferred" class="form-checkbox h-5 w-5 text-sys-warn bg-transparent border-sys-warn rounded-none focus:ring-0 focus:ring-offset-0">
                            <span class="text-sys-text font-bold text-sys-warn">â³ é æ”¶å¸³æ¬¾ (æš«ä¸è¨ˆå…¥æ”¶å…¥)</span>
                        </label>
                    </div>

                    <div id="option-realization" class="hidden">
                        <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-success/50">
                           <input type="checkbox" id="inp-realization" class="form-checkbox h-5 w-5 text-sys-success bg-transparent border-sys-success rounded-none focus:ring-0 focus:ring-offset-0">
                           <span class="text-sys-text font-bold text-sys-success">ğŸš€ èªåˆ—ç‚ºå¯¦è³ªæ”¶å…¥ (æ ¸éŠ·)</span>
                       </label>
                       <p class="text-xs text-gray-400 mt-1 pl-2">* å‹¾é¸å¾Œï¼Œæ­¤ç­†è½‰å¸³é‡‘é¡å°‡è¨ˆå…¥ã€Œæœ¬æœˆæ”¶å…¥ã€åœ–è¡¨ã€‚</p>
                   </div>

                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">é‡‘é¡</label>
                        <input type="number" id="inp-amount" placeholder="0" required min="0" step="0.01" class="w-full text-2xl font-bold text-sys-blue">
                    </div>
                    <div class="grid grid-cols-2 gap-4" id="account-group">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase" id="lbl-from">å¸³æˆ¶</label>
                            <select id="inp-account-from" required class="w-full"></select>
                        </div>
                         <div id="group-account-to" class="hidden">
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">è½‰å…¥å¸³æˆ¶</label>
                            <select id="inp-account-to" class="w-full"></select>
                        </div>
                    </div>
                    <div id="group-category">
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">åˆ†é¡</label>
                         <select id="inp-category" required class="w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">å‚™è¨» / æè¿°</label>
                        <input type="text" id="inp-note" placeholder="ä¾‹å¦‚ï¼šå…¨å®¶åˆé¤" class="w-full">
                    </div>
                    <button type="submit" class="sys-btn w-full py-4 text-lg"><i class="fa-solid fa-floppy-disk mr-2"></i> ç¢ºèªç™»éŒ„</button>
                    <button type="button" id="btn-delete-tx" class="hidden sys-btn sys-btn-danger w-full mt-2" onclick="deleteCurrentTx()"><i class="fa-solid fa-trash mr-2"></i> åˆªé™¤ç´€éŒ„</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-account" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-account')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 bg-sys-bg">
            <h3 class="text-xl font-bold text-sys-blue uppercase mb-4" id="modal-account-title">æ–°å¢/ç·¨è¼¯å¸³æˆ¶</h3>
            <input type="hidden" id="inp-acc-original-name">
            <div class="space-y-4">
                <div>
                    <label class="block text-sys-blue text-sm font-bold mb-2">å¸³æˆ¶åç¨±</label>
                    <input type="text" id="inp-acc-name" class="w-full" placeholder="ä¾‹å¦‚ï¼šæ°¸è± (é æ”¶æš«å­˜)">
                </div>
                <div>
                    <label class="block text-sys-blue text-sm font-bold mb-2">ç•¶å‰/åˆå§‹ é¤˜é¡</label>
                    <input type="number" id="inp-acc-balance" class="w-full" step="1" placeholder="0">
                    <p class="text-xs text-gray-400 mt-1">* å»ºè­°æ‚¨å»ºç«‹ä¸€å€‹ã€Œé æ”¶æš«å­˜ã€å¸³æˆ¶ä¾†ç®¡ç†å­¸è²»ã€‚</p>
                </div>
                <button onclick="saveAccount()" class="sys-btn w-full">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-cats" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-cats')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 h-3/4 flex flex-col bg-sys-bg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-sys-blue uppercase"><i class="fa-solid fa-tags mr-2"></i>åˆ†é¡æ¶æ§‹ç®¡ç†</h3>
                <button onclick="toggleModal('modal-cats')" class="text-sys-text"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex mb-4 border-b border-sys-blue/30 shrink-0">
                <button onclick="switchCatType('expense')" id="tab-cat-expense" class="flex-1 py-2 text-sm text-sys-blue border-b-2 border-sys-blue font-bold">æ”¯å‡º</button>
                <button onclick="switchCatType('income')" id="tab-cat-income" class="flex-1 py-2 text-sm text-gray-500">æ”¶å…¥</button>
            </div>
            <div class="flex gap-2 mb-4 shrink-0">
                <input type="text" id="new-cat-name" placeholder="æ–°å¢åˆ†é¡åç¨±..." class="flex-1">
                <button onclick="addCategory()" class="sys-btn py-1 px-4"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="cat-list-container" class="overflow-y-auto custom-scrollbar flex-1 space-y-1 pr-2"></div>
        </div>
    </div>

    <div id="modal-rules" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-rules')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 h-3/4 flex flex-col bg-sys-bg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-sys-blue uppercase"><i class="fa-solid fa-robot mr-2"></i>è‡ªå‹•åˆ†é¡è¨˜æ†¶åº«</h3>
                <button onclick="toggleModal('modal-rules')" class="text-sys-text"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-xs text-gray-400 mb-4 shrink-0">ç•¶å‚™è¨»åŒ…å«ç‰¹å®šé—œéµå­—æ™‚ï¼Œç³»çµ±å°‡è‡ªå‹•æ­¸é¡ã€‚</p>
            <div id="rule-list-container" class="overflow-y-auto custom-scrollbar flex-1 space-y-2 pr-2"></div>
        </div>
    </div>

    <div id="modal-db" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleModal('modal-db')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative z-10 border-sys-danger/50 shadow-[0_0_30px_rgba(255,51,51,0.1)] bg-sys-bg">
            <div class="flex justify-between items-center mb-6 border-b border-sys-danger/30 pb-3">
                <h3 class="text-xl font-bold text-sys-danger uppercase"><i class="fa-solid fa-shield-halved mr-2"></i>ç³»çµ±æ ¸å¿ƒ (Core)</h3>
                <button onclick="toggleModal('modal-db')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="space-y-4">
                <button onclick="exportData()" class="sys-btn w-full"><i class="fa-solid fa-file-export mr-2"></i> åŒ¯å‡ºå‚™ä»½ (JSON)</button>
                <div class="relative">
                    <button class="sys-btn w-full"><i class="fa-solid fa-file-import mr-2"></i> åŒ¯å…¥é‚„åŸ</button>
                    <input type="file" id="import-file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="importData(event)">
                </div>
                <div class="border-t border-sys-danger/30 my-4"></div>
                <button onclick="resetData()" class="sys-btn sys-btn-danger w-full"><i class="fa-solid fa-skull mr-2"></i> æ ¼å¼åŒ–é‡ç½®ç³»çµ±</button>
            </div>
        </div>
    </div>

    <div id="system-toast-container" class="fixed top-20 right-4 z-50 flex flex-col space-y-4 pointer-events-none"></div>

    <script>
        // ================= STATE =================
        const APP_ID = 'finsys_solo_v7';
        // V7: Ensure 'ä¿¡ç”¨å¡' is in defaults
        const DEFAULT_ACCOUNTS = ['æ°¸è± (æ´»å­˜)', 'æ°¸è± (é æ”¶æš«å­˜)', 'ç¾é‡‘', 'ä¿¡ç”¨å¡'];
        const DEFAULT_CATEGORIES = {
            expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'å…¶ä»–æ”¯å‡º'],
            income: ['è–ªè³‡', 'èª²ç¨‹æ”¶å…¥', 'é æ”¶å­¸è²»', 'æŠ•è³‡'],
            transfer: ['å…§éƒ¨è½‰å¸³', 'æ ¸éŠ·èªåˆ—', 'ä¿¡ç”¨å¡ç¹³è²»']
        };

        let state = {
            transactions: [],
            accounts: [...DEFAULT_ACCOUNTS],
            categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
            keywordMap: {}, 
            settings: { currency: 'TWD' },
            ui: {
                currentView: 'view-accounts',
                chartYear: new Date().getFullYear(),
                chartMonth: 'all',
                activeAccountDetail: null,
                catManageType: 'expense'
            }
        };

        // ================= UTILS =================
        function showSystemToast(message, type = 'success') {
            const container = document.getElementById('system-toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-triangle-exclamation';
            const color = type === 'success' ? 'sys-success' : 'sys-danger';
            toast.className = `system-toast sys-panel p-4 flex items-center shadow-lg border-${color} mb-3 pointer-events-auto`;
            toast.innerHTML = `<i class="fa-solid ${icon} text-${color} text-xl mr-3"></i><span class="font-bold uppercase tracking-wider text-${color}">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3400);
        }

        const toggleModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.toggle('hidden');
        };

        const formatCurrency = (num) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: state.settings.currency, minimumFractionDigits: 0 }).format(num);

        // ================= DATA LOGIC =================
        const loadData = () => {
            const saved = localStorage.getItem(APP_ID);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed, keywordMap: parsed.keywordMap || {} };
                    state.transactions = state.transactions.map(tx => ({ 
                        ...tx, 
                        isVerified: tx.hasOwnProperty('isVerified') ? tx.isVerified : true,
                        isRealization: tx.hasOwnProperty('isRealization') ? tx.isRealization : false
                    }));
                } catch (e) { showSystemToast("è³‡æ–™è¼‰å…¥å¤±æ•—", 'error'); }
            }
        };
        const saveData = () => { localStorage.setItem(APP_ID, JSON.stringify(state)); renderApp(); };

        const upsertTransaction = (tx) => {
            const index = state.transactions.findIndex(t => t.id === tx.id);
            if (index > -1) {
                state.transactions[index] = { ...state.transactions[index], ...tx };
                showSystemToast("ç´€éŒ„å·²æ›´æ–°");
            } else {
                state.transactions.unshift({ id: Date.now().toString(), createdAt: new Date().toISOString(), ...tx });
                showSystemToast("ç´€éŒ„å·²æ–°å¢");
                learnKeyword(tx.note, tx.category, tx.type);
            }
            saveData();
            toggleModal('modal-tx');
        };

        const deleteCurrentTx = () => {
            const id = document.getElementById('inp-id').value;
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                saveData();
                toggleModal('modal-tx');
                showSystemToast("ç´€éŒ„å·²åˆªé™¤", 'error');
            }
        };

        const learnKeyword = (note, category, type) => {
            if (!note || type === 'transfer') return;
            const keyword = note.trim().substring(0, 2); 
            if (keyword.length >= 2 && !state.keywordMap[keyword]) state.keywordMap[keyword] = category;
        };

        const getBalance = (accountName) => {
            let balance = 0;
            state.transactions.forEach(tx => {
                const amt = parseFloat(tx.amount);
                if (tx.type === 'income' && tx.accountFrom === accountName) balance += amt;
                if (tx.type === 'expense' && tx.accountFrom === accountName) balance -= amt;
                if (tx.type === 'transfer') {
                    if (tx.accountFrom === accountName) balance -= amt;
                    if (tx.accountTo === accountName) balance += amt;
                }
            });
            return balance;
        };

        // ================= VIEW CONTROLLERS =================
        const switchView = (viewId) => {
            state.ui.currentView = viewId;
            if (viewId !== 'view-accounts') state.ui.activeAccountDetail = null;
            renderApp();
        };

        const renderApp = () => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(state.ui.currentView.replace('view', 'nav')).classList.add('active');
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';
            
            switch(state.ui.currentView) {
                case 'view-dashboard': renderDashboard(mainContent); break;
                case 'view-records': renderRecords(mainContent); break;
                case 'view-accounts': renderAccountsView(mainContent); break;
                case 'view-settings': renderSettings(mainContent); break;
            }
        };

        // --- 1. Dashboard ---
        const renderDashboard = (container) => {
            const now = new Date();
            const thisMonthPrefix = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            let incomeMonth = 0, expenseMonth = 0;
            
            state.transactions.filter(tx => tx.date.startsWith(thisMonthPrefix)).forEach(tx => {
                const amt = parseFloat(tx.amount);
                if (tx.type === 'income' && tx.isVerified !== false) incomeMonth += amt;
                if (tx.type === 'transfer' && tx.isRealization === true) incomeMonth += amt;
                if (tx.type === 'expense') expenseMonth += amt;
            });
            const netMonth = incomeMonth - expenseMonth;

            const yearOptions = getAvailableYears().map(y => `<option value="${y}" ${y === state.ui.chartYear ? 'selected' : ''}>${y} å¹´</option>`).join('');
            const monthOptions = `<option value="all" ${state.ui.chartMonth === 'all' ? 'selected' : ''}>å…¨å¹´</option>` + 
                                 Array.from({length: 12}, (_, i) => `<option value="${i}" ${state.ui.chartMonth == i ? 'selected' : ''}>${i+1} æœˆ</option>`).join('');

            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="sys-panel p-4 border-l-4 border-sys-success">
                        <h3 class="text-xs uppercase text-sys-success font-bold mb-1">æœ¬æœˆæ”¶å…¥</h3>
                        <p class="text-2xl font-bold">${formatCurrency(incomeMonth)}</p>
                    </div>
                     <div class="sys-panel p-4 border-l-4 border-sys-danger">
                        <h3 class="text-xs uppercase text-sys-danger font-bold mb-1">æœ¬æœˆæ”¯å‡º</h3>
                        <p class="text-2xl font-bold">${formatCurrency(expenseMonth)}</p>
                    </div>
                    <div class="sys-panel p-4 col-span-2 flex justify-between items-center ${netMonth >= 0 ? 'border-sys-blue' : 'border-sys-danger'} border-2">
                        <div>
                            <h3 class="text-sm uppercase text-sys-blue font-bold mb-1">æœ¬æœˆæ·¨ç¾é‡‘æµ</h3>
                            <p class="text-3xl font-bold ${netMonth >= 0 ? 'text-sys-success' : 'text-sys-danger'} drop-shadow-[0_0_5px_currentColor]">${formatCurrency(netMonth)}</p>
                        </div>
                    </div>
                </div>
                <div class="sys-panel p-4 relative z-10">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h3 class="text-sys-blue uppercase font-bold tracking-widest"><i class="fa-solid fa-chart-pie mr-2"></i>æ”¶æ”¯è¶¨å‹¢åˆ†æ</h3>
                        <div class="flex space-x-2">
                            <select onchange="updateChartFilter('year', this.value)" class="sys-btn dashboard-select bg-sys-bg text-sys-text border-sys-blue">${yearOptions}</select>
                            <select onchange="updateChartFilter('month', this.value)" class="sys-btn dashboard-select bg-sys-bg text-sys-text border-sys-blue">${monthOptions}</select>
                        </div>
                    </div>
                    <div class="h-64"><canvas id="mainChart"></canvas></div>
                </div>
            `;
            renderChart();
        };

        const getAvailableYears = () => {
            const years = new Set([new Date().getFullYear(), new Date().getFullYear() + 1]);
            state.transactions.forEach(tx => years.add(new Date(tx.date).getFullYear()));
            return Array.from(years).sort((a, b) => b - a);
        };
        const updateChartFilter = (type, value) => {
            if (type === 'year') state.ui.chartYear = parseInt(value);
            if (type === 'month') state.ui.chartMonth = value === 'all' ? 'all' : parseInt(value);
            renderApp();
        };
        const renderChart = () => {
            const ctx = document.getElementById('mainChart').getContext('2d');
            Chart.defaults.color = '#e0e0ff'; Chart.defaults.borderColor = 'rgba(0, 225, 255, 0.1)';
            const targetYear = state.ui.chartYear; const targetMonth = state.ui.chartMonth;
            let labels = [], incomeData = [], expenseData = [];

            if (targetMonth === 'all') {
                labels = Array.from({length: 12}, (_, i) => `${i+1}æœˆ`);
                for (let i = 0; i < 12; i++) {
                    const prefix = `${targetYear}-${String(i + 1).padStart(2, '0')}`;
                    let inc = 0, exp = 0;
                    state.transactions.filter(tx => tx.date.startsWith(prefix)).forEach(tx => {
                        const amt = parseFloat(tx.amount);
                        if (tx.type === 'income' && tx.isVerified !== false) inc += amt;
                        if (tx.type === 'transfer' && tx.isRealization === true) inc += amt;
                        if (tx.type === 'expense') exp += amt;
                    });
                    incomeData.push(inc); expenseData.push(exp);
                }
            } else {
                const prefix = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}`;
                const catMap = {};
                state.transactions.filter(tx => tx.date.startsWith(prefix) && tx.type === 'expense').forEach(tx => {
                    catMap[tx.category] = (catMap[tx.category] || 0) + parseFloat(tx.amount);
                });
                const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 5);
                labels = sorted.map(i => i[0]); expenseData = sorted.map(i => i[1]);
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: targetMonth !== 'all' ? [{ label: 'å‰äº”å¤§æ”¯å‡º', data: expenseData, backgroundColor: 'rgba(255, 51, 51, 0.7)', borderColor: '#ff3333', borderWidth: 1 }]
                                     : [{ label: 'æ”¶å…¥', data: incomeData, backgroundColor: 'rgba(51, 255, 87, 0.7)', borderColor: '#33ff57', borderWidth: 1 },
                                        { label: 'æ”¯å‡º', data: expenseData, backgroundColor: 'rgba(255, 51, 51, 0.7)', borderColor: '#ff3333', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        };

        // --- 2. Accounts ---
        const renderAccountsView = (container) => {
            if (state.ui.activeAccountDetail) { renderAccountDetail(container, state.ui.activeAccountDetail); return; }
            const totalAsset = state.accounts.reduce((sum, acc) => sum + getBalance(acc), 0);
            let html = `
                <div class="sys-panel p-6 flex flex-col items-center justify-center mb-6 shadow-neon-blue relative overflow-hidden">
                    <div class="absolute inset-0 bg-sys-blue opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-sys-blue to-transparent pointer-events-none"></div>
                    <h2 class="text-sys-blue uppercase tracking-widest text-sm font-bold mb-2">ç³»çµ±ç¸½è³‡ç”¢ (Net Worth)</h2>
                    <p class="text-4xl font-bold text-white drop-shadow-[0_0_10px_rgba(0,225,255,0.8)]">${formatCurrency(totalAsset)}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;
            state.accounts.forEach(acc => {
                const bal = getBalance(acc);
                html += `
                    <div class="sys-panel p-5 flex justify-between items-center cursor-pointer hover:shadow-neon-blue transition-all" onclick="openAccountDetail('${acc}')">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-sys-blue/20 flex items-center justify-center border border-sys-blue mr-4"><i class="fa-solid fa-credit-card text-sys-blue"></i></div>
                            <span class="font-bold text-lg uppercase">${acc}</span>
                        </div>
                        <span class="font-bold text-xl ${bal >= 0 ? 'text-sys-blue' : 'text-sys-danger'}">${formatCurrency(bal)}</span>
                    </div>`;
            });
            html += `<button onclick="openAccountModal()" class="sys-panel p-5 flex items-center justify-center border-dashed border-sys-blue/50 text-sys-blue/70 hover:text-sys-blue hover:border-sys-blue transition-all uppercase font-bold tracking-widest"><i class="fa-solid fa-plus-circle mr-2"></i> æ“´å……å¸³æˆ¶æ§½ä½</button></div>`;
            container.innerHTML = html;
        };

        const openAccountDetail = (acc) => { state.ui.activeAccountDetail = acc; renderApp(); };
        const renderAccountDetail = (container, acc) => {
            const bal = getBalance(acc);
            const accountTx = state.transactions.filter(tx => tx.accountFrom === acc || tx.accountTo === acc);
            container.innerHTML = `
                <button onclick="state.ui.activeAccountDetail = null; renderApp()" class="mb-4 text-sys-blue hover:underline flex items-center uppercase font-bold"><i class="fa-solid fa-chevron-left mr-2"></i> è¿”å›å¸³æˆ¶ç¸½è¦½</button>
                <div class="sys-panel p-6 mb-6 border-l-4 border-sys-blue flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold uppercase text-sys-blue mb-2">${acc} // ç‹€æ…‹è©³æƒ…</h2>
                        <p class="text-3xl font-bold ${bal >= 0 ? 'text-sys-blue' : 'text-sys-danger'}">${formatCurrency(bal)}</p>
                    </div>
                    <button onclick="openAccountModal('${acc}')" class="sys-btn text-xs"><i class="fa-solid fa-pen mr-2"></i>ç·¨è¼¯å¸³æˆ¶</button>
                </div>
                <h3 class="text-sys-blue uppercase font-bold mb-4 tracking-widest"><i class="fa-solid fa-list-ul mr-2"></i>äº¤æ˜“æµæ°´ç´€éŒ„</h3>
                <div class="space-y-3">
                    ${accountTx.length === 0 ? '<div class="sys-panel p-8 text-center text-gray-400">å°šç„¡ç´€éŒ„</div>' : accountTx.map(tx => renderTransactionItem(tx)).join('')}
                </div>
            `;
        };

        // --- 3. Records ---
        const renderRecords = (container) => {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-sys-blue uppercase tracking-widest">è¿‘æœŸç³»çµ±ç´€éŒ„</h2></div>
                <div class="space-y-3">${state.transactions.length === 0 ? '<div class="sys-panel p-8 text-center text-gray-400">å°šç„¡æ•¸æ“š</div>' : state.transactions.map(tx => renderTransactionItem(tx)).join('')}</div>
            `;
        };

        const renderTransactionItem = (tx) => {
            const isExpense = tx.type === 'expense'; const isTransfer = tx.type === 'transfer';
            const isPending = tx.type === 'income' && tx.isVerified === false;
            const isRealization = tx.type === 'transfer' && tx.isRealization === true;
            
            let icon = isExpense ? 'fa-arrow-trend-down' : (isTransfer ? 'fa-right-left' : 'fa-arrow-trend-up');
            let color = isExpense ? 'text-sys-danger' : (isTransfer ? 'text-sys-blue' : 'text-sys-success');
            
            if (isPending) { color = 'text-sys-warn'; icon = 'fa-clock'; }
            if (isRealization) { color = 'text-sys-success'; icon = 'fa-check-double'; }

            return `
                <div class="sys-panel p-4 flex justify-between items-center relative overflow-hidden group cursor-pointer hover:bg-sys-blue/5 transition-colors" onclick="openTransactionModal('${tx.id}')">
                    <div class="flex items-center gap-3 z-10">
                        <div class="w-10 h-10 flex items-center justify-center border border-sys-blue/50 bg-sys-blue/10 ${color}"><i class="fa-solid ${icon}"></i></div>
                        <div>
                            <div class="font-bold uppercase text-sm ${color}">
                                ${tx.category} 
                                ${isPending ? '(é æ”¶æš«å­˜)' : ''}
                                ${isRealization ? '(æ ¸éŠ·æ”¶å…¥)' : ''}
                            </div>
                            <div class="text-xs text-gray-400">${tx.date} | ${tx.note || 'ç„¡å‚™è¨»'}</div>
                        </div>
                    </div>
                    <div class="text-right z-10 flex flex-col items-end gap-2">
                        <span class="font-bold text-lg ${color}">${isExpense?'-':(isTransfer?'':'+')}${formatCurrency(tx.amount)}</span>
                        ${isTransfer ? `<span class="text-xs text-gray-500">${tx.accountFrom} &rarr; ${tx.accountTo}</span>` : ''}
                    </div>
                </div>`;
        };

        // --- 4. Settings ---
        const renderSettings = (container) => {
            container.innerHTML = `
                <h2 class="text-xl font-bold text-sys-blue uppercase mb-6 tracking-widest">ç³»çµ±è¨­å®š & å·¥å…·</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div onclick="openCatsModal()" class="sys-panel p-6 flex justify-between items-center cursor-pointer hover:border-sys-blue transition-all group">
                        <div><h3 class="text-lg font-bold text-sys-blue uppercase"><i class="fa-solid fa-tags mr-2"></i>åˆ†é¡æ¶æ§‹ç®¡ç†</h3><p class="text-xs text-gray-400">æ–°å¢æˆ–ç§»é™¤æ”¯å‡º/æ”¶å…¥åˆ†é¡</p></div>
                        <i class="fa-solid fa-chevron-right text-sys-blue opacity-50 group-hover:opacity-100"></i>
                    </div>
                    <div onclick="openRulesModal()" class="sys-panel p-6 flex justify-between items-center cursor-pointer hover:border-sys-blue transition-all group">
                        <div><h3 class="text-lg font-bold text-sys-blue uppercase"><i class="fa-solid fa-robot mr-2"></i>è‡ªå‹•åˆ†é¡è¨˜æ†¶åº«</h3><p class="text-xs text-gray-400">ç®¡ç†é—œéµå­—è‡ªå‹•æ­¸é¡è¦å‰‡</p></div>
                        <i class="fa-solid fa-chevron-right text-sys-blue opacity-50 group-hover:opacity-100"></i>
                    </div>
                    <div onclick="toggleModal('modal-db')" class="sys-panel p-6 flex justify-between items-center cursor-pointer hover:border-sys-danger border-sys-danger/50 group">
                        <div><h3 class="text-lg font-bold text-sys-danger uppercase"><i class="fa-solid fa-shield-halved mr-2"></i>ç³»çµ±æ ¸å¿ƒè³‡æ–™åº«</h3><p class="text-xs text-gray-400">å‚™ä»½ã€é‚„åŸèˆ‡ç³»çµ±é‡ç½®</p></div>
                        <i class="fa-solid fa-chevron-right text-sys-danger opacity-50 group-hover:opacity-100"></i>
                    </div>
                    <div class="sys-panel p-6 border-t-4 border-sys-purple mt-4">
                        <h3 class="text-lg font-bold text-sys-purple uppercase mb-4"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>æ™ºèƒ½æ‰¹æ¬¡è§£æ</h3>
                        <textarea id="batch-input" rows="4" placeholder="è²¼ä¸Šæ–‡å­—ï¼Œå¦‚ï¼š&#10;12/25 Costcoé¤é£² 500 ä¿¡ç”¨å¡&#10;12/25 Costcoä»£å¢Š 1800 ä¿¡ç”¨å¡" class="w-full mb-4 font-mono text-sm"></textarea>
                        <button onclick="processBatch()" class="sys-btn w-full !border-sys-purple !text-sys-purple hover:!bg-sys-purple hover:!text-white">åŸ·è¡Œè§£æç¨‹åº</button>
                    </div>
                </div>
            `;
        };

        // ================= MODAL LOGIC =================
        const openTransactionModal = (id = null) => {
            document.getElementById('form-tx').reset();
            const dateInput = document.getElementById('inp-date');
            const typeSelect = document.getElementById('inp-type');
            
            if (id) {
                const tx = state.transactions.find(t => t.id === id);
                if (!tx) return;
                document.getElementById('modal-tx-title').innerHTML = '<i class="fa-solid fa-pen mr-2"></i>ç·¨è¼¯ç´€éŒ„';
                document.getElementById('inp-id').value = tx.id;
                dateInput.value = tx.date;
                typeSelect.value = tx.type;
                document.getElementById('inp-amount').value = tx.amount;
                document.getElementById('inp-note').value = tx.note || '';
                
                document.getElementById('inp-deferred').checked = tx.isVerified === false;
                document.getElementById('inp-realization').checked = tx.isRealization === true;
                
                populateAccountSelects();
                updateCategoryOptions();
                
                document.getElementById('inp-account-from').value = tx.accountFrom;
                document.getElementById('inp-category').value = tx.category;
                if(tx.accountTo) document.getElementById('inp-account-to').value = tx.accountTo;
                
                document.getElementById('btn-delete-tx').classList.remove('hidden');
            } else {
                document.getElementById('modal-tx-title').innerHTML = '<i class="fa-solid fa-plus mr-2"></i>æ–°å¢ç´€éŒ„';
                document.getElementById('inp-id').value = '';
                dateInput.valueAsDate = new Date();
                typeSelect.value = 'expense';
                document.getElementById('inp-deferred').checked = false;
                document.getElementById('inp-realization').checked = false;
                populateAccountSelects();
                updateCategoryOptions();
                document.getElementById('btn-delete-tx').classList.add('hidden');
            }
            toggleModal('modal-tx');
        };

        document.getElementById('form-tx').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('inp-type').value;
            const tx = {
                id: document.getElementById('inp-id').value || Date.now().toString(),
                date: document.getElementById('inp-date').value,
                type: type,
                amount: parseFloat(document.getElementById('inp-amount').value),
                category: document.getElementById('inp-category').value,
                accountFrom: document.getElementById('inp-account-from').value,
                note: document.getElementById('inp-note').value,
            };
            
            if (type === 'transfer') {
                tx.accountTo = document.getElementById('inp-account-to').value;
                if (tx.accountFrom === tx.accountTo) return showSystemToast('è½‰å‡ºè½‰å…¥å¸³æˆ¶ä¸å¯ç›¸åŒ', 'error');
                tx.isRealization = document.getElementById('inp-realization').checked;
            } else {
                tx.isRealization = false;
            }

            if (type === 'income') {
                tx.isVerified = !document.getElementById('inp-deferred').checked;
            } else {
                tx.isVerified = true;
            }

            upsertTransaction(tx);
        });

        const populateAccountSelects = () => {
            const from = document.getElementById('inp-account-from');
            const to = document.getElementById('inp-account-to');
            from.innerHTML = ''; to.innerHTML = '';
            state.accounts.forEach(acc => {
                from.add(new Option(acc, acc));
                to.add(new Option(acc, acc));
            });
            if (state.accounts.length > 1) to.selectedIndex = 1;
        };

        const updateCategoryOptions = () => {
            const type = document.getElementById('inp-type').value;
            const catSelect = document.getElementById('inp-category');
            const toGroup = document.getElementById('group-account-to');
            const lblFrom = document.getElementById('lbl-from');
            const revGroup = document.getElementById('option-deferred');
            const realGroup = document.getElementById('option-realization');
            
            catSelect.innerHTML = '';
            state.categories[type].forEach(cat => catSelect.add(new Option(cat, cat)));

            if (type === 'transfer') {
                toGroup.classList.remove('hidden'); lblFrom.innerText = 'è½‰å‡ºå¸³æˆ¶';
                revGroup.classList.add('hidden');
                realGroup.classList.remove('hidden');
            } else {
                toGroup.classList.add('hidden'); lblFrom.innerText = type === 'income' ? 'å­˜å…¥å¸³æˆ¶' : 'æ”¯å‡ºå¸³æˆ¶';
                revGroup.classList.toggle('hidden', type !== 'income');
                realGroup.classList.add('hidden');
            }
        };

        const openAccountModal = (accName = null) => {
            document.getElementById('inp-acc-original-name').value = accName || '';
            const nameInp = document.getElementById('inp-acc-name');
            const balInp = document.getElementById('inp-acc-balance');
            
            if (accName) {
                document.getElementById('modal-account-title').innerText = 'ç·¨è¼¯å¸³æˆ¶';
                nameInp.value = accName;
                balInp.value = getBalance(accName);
            } else {
                document.getElementById('modal-account-title').innerText = 'æ–°å¢å¸³æˆ¶';
                nameInp.value = '';
                balInp.value = '';
            }
            toggleModal('modal-account');
        };

        const saveAccount = () => {
            const originalName = document.getElementById('inp-acc-original-name').value;
            const newName = document.getElementById('inp-acc-name').value.trim();
            const newBal = parseFloat(document.getElementById('inp-acc-balance').value);
            
            if (!newName) return showSystemToast("è«‹è¼¸å…¥å¸³æˆ¶åç¨±", 'error');

            if (originalName) {
                if (originalName !== newName) {
                    if (state.accounts.includes(newName)) return showSystemToast("å¸³æˆ¶åç¨±å·²å­˜åœ¨", 'error');
                    state.accounts = state.accounts.map(a => a === originalName ? newName : a);
                    state.transactions.forEach(tx => {
                        if (tx.accountFrom === originalName) tx.accountFrom = newName;
                        if (tx.accountTo === originalName) tx.accountTo = newName;
                    });
                }
                const currentBal = getBalance(newName);
                const diff = newBal - currentBal;
                if (diff !== 0 && !isNaN(newBal)) {
                    upsertTransaction({
                        id: Date.now().toString(),
                        date: new Date().toISOString().split('T')[0],
                        type: diff > 0 ? 'income' : 'expense',
                        amount: Math.abs(diff),
                        category: 'ç³»çµ±èª¿æ•´',
                        accountFrom: newName,
                        note: 'å¸³æˆ¶é¤˜é¡ä¿®æ­£',
                        isVerified: true
                    });
                }
                showSystemToast("å¸³æˆ¶æ›´æ–°æˆåŠŸ");
            } else {
                if (state.accounts.includes(newName)) return showSystemToast("å¸³æˆ¶åç¨±å·²å­˜åœ¨", 'error');
                state.accounts.push(newName);
                if (!isNaN(newBal) && newBal !== 0) {
                     upsertTransaction({
                        id: Date.now().toString(),
                        date: new Date().toISOString().split('T')[0],
                        type: newBal > 0 ? 'income' : 'expense',
                        amount: Math.abs(newBal),
                        category: 'ç³»çµ±èª¿æ•´',
                        accountFrom: newName,
                        note: 'åˆå§‹é¤˜é¡',
                        isVerified: true
                    });
                }
                showSystemToast("å¸³æˆ¶å·²æ–°å¢");
            }
            saveAccountFinish();
        };
        const saveAccountFinish = () => {
            saveData();
            toggleModal('modal-account');
            if(state.ui.currentView === 'view-accounts' && state.ui.activeAccountDetail) {
               state.ui.activeAccountDetail = document.getElementById('inp-acc-name').value; 
            }
            renderApp();
        };

        const openCatsModal = () => { toggleModal('modal-cats'); renderCatList(); };
        const switchCatType = (type) => { state.ui.catManageType = type; renderCatList(); };
        const renderCatList = () => {
            const type = state.ui.catManageType;
            const tabExp = document.getElementById('tab-cat-expense');
            const tabInc = document.getElementById('tab-cat-income');
            if (type === 'expense') {
                tabExp.className = "flex-1 py-2 text-sm text-sys-blue border-b-2 border-sys-blue font-bold";
                tabInc.className = "flex-1 py-2 text-sm text-gray-500";
            } else {
                tabInc.className = "flex-1 py-2 text-sm text-sys-blue border-b-2 border-sys-blue font-bold";
                tabExp.className = "flex-1 py-2 text-sm text-gray-500";
            }
            const list = state.categories[type].map(c => `
                <div class="flex justify-between items-center p-3 bg-sys-blue/5 border border-sys-blue/20">
                    <span>${c}</span>
                    <button onclick="deleteCategory('${type}', '${c}')" class="text-gray-500 hover:text-sys-danger"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `).join('');
            document.getElementById('cat-list-container').innerHTML = list;
        };
        const addCategory = () => {
            const val = document.getElementById('new-cat-name').value.trim();
            const type = state.ui.catManageType;
            if (val && !state.categories[type].includes(val)) {
                state.categories[type].push(val);
                document.getElementById('new-cat-name').value = '';
                saveData(); renderCatList();
            }
        };
        const deleteCategory = (type, val) => {
            if(confirm(`åˆªé™¤ [${val}]?`)) {
                state.categories[type] = state.categories[type].filter(c => c !== val);
                saveData(); renderCatList();
            }
        };

        const openRulesModal = () => { toggleModal('modal-rules'); renderRuleList(); };
        const renderRuleList = () => {
            const html = Object.keys(state.keywordMap).length === 0 ? '<p class="text-gray-400 text-sm">ç„¡è¦å‰‡</p>' : 
            Object.entries(state.keywordMap).map(([k, c]) => `
                <div class="flex justify-between items-center p-3 bg-sys-blue/5 border border-sys-blue/20">
                    <span class="text-sm">"${k}" &rarr; <strong class="text-sys-purple">${c}</strong></span>
                    <button onclick="deleteRule('${k}')" class="text-gray-500 hover:text-sys-danger"><i class="fa-solid fa-xmark"></i></button>
                </div>`).join('');
            document.getElementById('rule-list-container').innerHTML = html;
        };
        const deleteRule = (k) => { delete state.keywordMap[k]; saveData(); renderRuleList(); };

        const processBatch = () => {
            const text = document.getElementById('batch-input').value;
            if (!text) return;
            const lines = text.split('\n').filter(l => l.trim());
            let count = 0;
            lines.forEach(line => {
                const match = line.match(/(\d{4}-\d{2}-\d{2}|\d{1,2}\/\d{1,2})\s+(.+?)\s+(\d+(\.\d+)?)\s*(\S+)?\s*(\((æ”¶å…¥|income)\))?/i);
                if (match) {
                    let [_, dateStr, note, amount, , account, typeTag] = match;
                    let date = dateStr.includes('-') ? dateStr : `${new Date().getFullYear()}-${dateStr.replace('/', '-').padStart(5, '0')}`;
                    if(date.length < 10) date = date.replace(/-(\d)$/,"-0$1").replace(/-(\d)-/,"-0$1-"); 
                    const type = typeTag ? 'income' : 'expense';
                    let targetAcc = (account && state.accounts.includes(account)) ? account : state.accounts[0];
                    let cat = type === 'income' ? state.categories.income[0] : state.categories.expense[0];
                    for (const [k, c] of Object.entries(state.keywordMap)) { if (note.includes(k)) { cat = c; break; } }
                    
                    state.transactions.unshift({
                        id: Date.now().toString() + Math.random(),
                        date, type, amount: parseFloat(amount), category: cat, accountFrom: targetAcc, note, isVerified: true, isRealization: false
                    });
                    count++;
                }
            });
            document.getElementById('batch-input').value = '';
            saveData(); showSystemToast(`è§£æå®Œæˆ ${count} ç­†`);
        };
        const exportData = () => {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = `finsys_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };
        const importData = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if(confirm('ç¢ºå®šé‚„åŸï¼Ÿ')) { state = JSON.parse(ev.target.result); saveData(); location.reload(); }
            };
            reader.readAsText(file);
        };
        const resetData = () => { if(prompt('è¼¸å…¥RESETé‡ç½®')==='RESET') { localStorage.removeItem(APP_ID); location.reload(); } };

        // Init
        document.documentElement.classList.add('dark');
        loadData();
        renderApp();
    </script>
</body>
</html>