<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¡å‹™ç³»çµ±é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        sys: {
                            bg: '#0a0a12',
                            panel: 'rgba(20, 20, 35, 0.95)', // æ·±è—è‰²åŠé€æ˜èƒŒæ™¯
                            blue: '#00e1ff',
                            purple: '#9d00ff',
                            text: '#e0e0ff',
                            danger: '#ff3333',
                            success: '#33ff57',
                            warn: '#ffbb00',
                            gray: '#94a3b8'
                        }
                    },
                    boxShadow: {
                        'neon-blue': '0 0 5px theme("colors.sys.blue"), 0 0 15px theme("colors.sys.blue")',
                    }
                }
            }
        }
    </script>

    <style>
        :root { color-scheme: dark; }
        
        body { 
            background-color: theme('colors.sys.bg'); 
            color: theme('colors.sys.text'); 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.sys.bg'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.sys.blue'); }

        /* é¢æ¿æ¨£å¼é‚„åŸ */
        .sys-panel {
            background: theme('colors.sys.panel');
            border: 1px solid theme('colors.sys.blue');
            box-shadow: inset 0 0 10px rgba(0, 225, 255, 0.1);
            position: relative;
            overflow: hidden;
            border-radius: 4px; /* å¾®åœ“è§’ */
        }
        .sys-panel::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, theme('colors.sys.blue'), transparent);
        }

        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input:not([type="checkbox"]), select, textarea {
            background-color: #1a1a2e !important;
            border: 1px solid theme('colors.sys.blue') !important;
            color: theme('colors.sys.text') !important;
            border-radius: 0 !important;
            padding: 0.75rem !important;
            transition: none !important; 
            -webkit-appearance: none;
            appearance: none;
            color-scheme: dark; 
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            box-shadow: theme('boxShadow.neon-blue') !important;
            background-color: #232342 !important;
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2300e1ff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; 
            background-repeat: no-repeat; 
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem !important; 
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .sys-btn {
            border: 1px solid theme('colors.sys.blue'); color: theme('colors.sys.blue');
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
            padding: 0.75rem 1.5rem; cursor: pointer; background: transparent;
            position: relative; overflow: hidden; transition: all 0.2s;
        }
        .sys-btn:hover { background: theme('colors.sys.blue'); color: theme('colors.sys.bg'); box-shadow: theme('boxShadow.neon-blue'); }
        .sys-btn-danger { border-color: theme('colors.sys.danger'); color: theme('colors.sys.danger'); }
        .sys-btn-danger:hover { background: theme('colors.sys.danger'); color: white; box-shadow: 0 0 15px theme('colors.sys.danger'); }

        .nav-item.active { color: theme('colors.sys.blue'); border-top: 2px solid theme('colors.sys.blue'); text-shadow: 0 0 10px theme('colors.sys.blue'); }
        
        /* Modal Fixes */
        .modal-wrapper { z-index: 100; }
        .hidden-force { display: none !important; }
        
        .modal-constraint {
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header { flex-shrink: 0; background-color: theme('colors.sys.bg'); z-index: 10; }
        .modal-body { flex-grow: 1; overflow-y: auto; min-height: 0; overscroll-behavior: contain; }

        /* å¼·åˆ¶é»æ“Š */
        button, .sys-btn, .nav-item, .record-item-row { cursor: pointer; pointer-events: auto !important; }
        
        #main-content { padding-bottom: 120px; }
    </style>
</head>
<body class="flex flex-col">

    <header class="sticky top-0 z-20 sys-panel p-4 flex justify-between items-center shadow-lg bg-sys-bg">
        <h1 class="text-2xl font-bold tracking-wider uppercase text-sys-blue drop-shadow-[0_0_5px_rgba(0,225,255,0.8)]">
            <i class="fa-solid fa-microchip mr-2"></i>è²¡å‹™ç³»çµ±
        </h1>
        <button onclick="openTxModal()" class="sys-btn text-sm px-4 py-2 flex items-center">
            <i class="fa-solid fa-plus mr-2"></i> ç´€éŒ„é‡‘æµ
        </button>
    </header>

    <main id="main-content" class="flex-1 overflow-y-auto p-4 space-y-6 relative"></main>

    <nav class="fixed bottom-0 left-0 right-0 sys-panel z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)] bg-sys-bg">
        <div class="flex justify-around">
            <button onclick="changeView('view-accounts')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-accounts">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-xs uppercase">å¸³æˆ¶ç¸½è¦½</span>
            </button>
            <button onclick="changeView('view-dashboard')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center active" id="nav-dashboard">
                <i class="fa-solid fa-chart-line text-xl mb-1"></i><span class="text-xs uppercase">å„€è¡¨æ¿</span>
            </button>
            <button onclick="changeView('view-records')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-records">
                <i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-xs uppercase">ç´€éŒ„</span>
            </button>
            <button onclick="changeView('view-settings')" class="nav-item w-full p-4 text-sys-text hover:text-sys-blue transition-all flex flex-col items-center" id="nav-settings">
                <i class="fa-solid fa-gears text-xl mb-1"></i><span class="text-xs uppercase">è¨­å®š</span>
            </button>
        </div>
    </nav>

    <div id="modal-tx" class="modal-wrapper fixed inset-0 hidden-force justify-center items-end sm:items-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('modal-tx')"></div>
        <div class="relative w-full sm:w-auto sm:max-w-lg bg-sys-bg rounded-t-2xl sm:rounded-2xl shadow-neon-blue modal-constraint">
            <div class="p-6 border-b border-sys-blue/30 pb-3 modal-header flex justify-between items-center">
                <h3 class="text-xl font-bold text-sys-blue uppercase" id="modal-tx-title"><i class="fa-solid fa-pen-to-square mr-2"></i>æ–°å¢ç´€éŒ„</h3>
                <button onclick="closeModal('modal-tx')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 modal-body custom-scrollbar">
                <div class="space-y-5">
                    <input type="hidden" id="inp-id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">æ—¥æœŸ</label>
                            <input type="date" id="inp-date" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">é¡å‹</label>
                            <select id="inp-type" class="w-full" onchange="refreshCats()">
                                <option value="expense">æ”¯å‡º</option>
                                <option value="income">æ”¶å…¥</option>
                                <option value="transfer">è½‰å¸³ / ç¹³è²»</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="opt-deferred" class="hidden-force">
                         <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-warn/50">
                            <input type="checkbox" id="chk-deferred" class="form-checkbox h-5 w-5 text-sys-warn bg-transparent border-sys-warn rounded-none">
                            <span class="text-sys-text font-bold text-sys-warn">â³ é æ”¶å¸³æ¬¾ (æš«ä¸è¨ˆå…¥æ”¶å…¥)</span>
                        </label>
                    </div>

                    <div id="opt-realize" class="hidden-force">
                        <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-success/50">
                           <input type="checkbox" id="chk-realize" class="form-checkbox h-5 w-5 text-sys-success bg-transparent border-sys-success rounded-none">
                           <span class="text-sys-text font-bold text-sys-success">ğŸš€ èªåˆ—ç‚ºå¯¦è³ªæ”¶å…¥ (æ ¸éŠ·)</span>
                       </label>
                    </div>

                   <div id="opt-exclude" class="hidden-force">
                        <label class="flex items-center space-x-3 p-3 sys-panel cursor-pointer border-sys-gray/50">
                            <input type="checkbox" id="chk-exclude" class="form-checkbox h-5 w-5 text-sys-gray bg-transparent border-sys-gray rounded-none">
                            <span class="text-sys-text font-bold text-sys-gray">ğŸš« ä¸åˆ—å…¥æ”¶æ”¯çµ±è¨ˆ</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1 pl-2">* å‹¾é¸å¾Œï¼Œæ­¤ç­†é‡‘é¡åªæœƒèª¿æ•´å¸³æˆ¶é¤˜é¡ï¼Œä¸è¨ˆå…¥åœ–è¡¨ã€‚</p>
                   </div>

                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">é‡‘é¡</label>
                        <div class="flex gap-2">
                            <input type="number" id="inp-amount" placeholder="0" class="w-full text-2xl font-bold text-sys-blue">
                            <button onclick="openSplitModal()" class="sys-btn px-4 bg-sys-blue/10 border-sys-purple text-sys-purple hover:bg-sys-purple hover:text-white">
                                <i class="fa-solid fa-scissors"></i> æ‹†å¸³
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase" id="lbl-from">å¸³æˆ¶</label>
                            <select id="sel-from" class="w-full"></select>
                        </div>
                         <div id="grp-to" class="hidden-force">
                            <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">è½‰å…¥å¸³æˆ¶</label>
                            <select id="sel-to" class="w-full"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">åˆ†é¡</label>
                         <select id="sel-cat" class="w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sys-blue text-sm font-bold mb-2 uppercase">å‚™è¨» / æè¿°</label>
                        <input type="text" id="inp-note" placeholder="ä¾‹å¦‚ï¼šå…¨å®¶åˆé¤" class="w-full">
                    </div>
                    <button onclick="saveTx()" class="sys-btn w-full py-4 text-lg mb-4"><i class="fa-solid fa-floppy-disk mr-2"></i> ç¢ºèªç™»éŒ„</button>
                    <button onclick="delTx()" id="btn-del" class="hidden-force sys-btn sys-btn-danger w-full mt-2"><i class="fa-solid fa-trash mr-2"></i> åˆªé™¤ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-split" class="modal-wrapper fixed inset-0 hidden-force justify-center items-end sm:items-center">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm" onclick="closeModal('modal-split')"></div>
        <div class="relative w-full sm:w-auto sm:max-w-lg bg-sys-bg rounded-t-2xl sm:rounded-2xl modal-constraint">
            <div class="p-4 border-b border-sys-blue flex justify-between items-center bg-sys-panel modal-header">
                <h3 class="text-xl font-bold text-sys-purple uppercase"><i class="fa-solid fa-scissors mr-2"></i>æ¶ˆè²»æ‹†å¸³</h3>
                <button onclick="closeModal('modal-split')" class="text-sys-text hover:text-sys-danger"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-4 modal-body custom-scrollbar">
                <div class="mb-4 text-center">
                    <p class="text-gray-400 text-xs uppercase tracking-widest mb-1">ç¸½é‡‘é¡</p>
                    <div class="text-3xl font-bold text-sys-blue" id="split-total">$0</div>
                </div>
                <div id="split-rows" class="space-y-3"></div>
                <div class="hidden-force mt-3 p-3 border border-dashed border-gray-600 rounded bg-gray-900/50 cursor-pointer" id="split-ghost" onclick="addSplitGhost()">
                    <div class="flex items-center justify-between text-gray-400 pointer-events-none">
                        <span><i class="fa-solid fa-plus-circle mr-2"></i> è‡ªå‹•å¡«å…¥å‰©é¤˜æ¬¾é …</span>
                        <span class="font-bold font-mono text-sys-purple" id="split-remain">$0</span>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-sys-blue bg-sys-panel modal-header flex gap-3">
                <div class="flex-1 text-xs flex flex-col justify-center">
                    <span class="text-gray-400">å·²åˆ†é…: <span id="split-sum" class="text-sys-text font-bold">$0</span></span>
                </div>
                <button onclick="confirmSplit()" class="sys-btn flex-1 !border-sys-purple !text-sys-purple hover:!bg-sys-purple hover:!text-white">
                    <i class="fa-solid fa-check-double mr-2"></i> ç¢ºèªæ‹†å¸³
                </button>
            </div>
        </div>
    </div>

    <div id="modal-acc" class="modal-wrapper fixed inset-0 hidden-force flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeModal('modal-acc')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative bg-sys-bg">
            <h3 class="text-xl font-bold text-sys-blue uppercase mb-4">å¸³æˆ¶ç®¡ç†</h3>
            <input type="hidden" id="acc-old">
            <div class="space-y-4">
                <input type="text" id="acc-name" class="w-full" placeholder="å¸³æˆ¶åç¨±">
                <input type="number" id="acc-bal" class="w-full" placeholder="ç•¶å‰é¤˜é¡">
                <button onclick="saveAcc()" class="sys-btn w-full">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-cats" class="modal-wrapper fixed inset-0 hidden-force flex items-center justify-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeModal('modal-cats')"></div>
        <div class="sys-panel w-full max-w-md m-4 p-6 relative bg-sys-bg h-3/4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-sys-blue uppercase">åˆ†é¡ç®¡ç†</h3>
                <button onclick="closeModal('modal-cats')" class="text-sys-text"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex mb-4 border-b border-sys-blue/30 shrink-0">
                <button onclick="setCatTab('expense')" id="tab-c-exp" class="flex-1 py-2 text-sys-blue border-b-2 border-sys-blue font-bold">æ”¯å‡º</button>
                <button onclick="setCatTab('income')" id="tab-c-inc" class="flex-1 py-2 text-gray-500">æ”¶å…¥</button>
            </div>
            <div class="flex gap-2 mb-4 shrink-0">
                <input type="text" id="new-cat" class="flex-1" placeholder="æ–°å¢åˆ†é¡...">
                <button onclick="addCat()" class="sys-btn py-1 px-4"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="cat-list" class="overflow-y-auto flex-1 space-y-1 pr-2 custom-scrollbar"></div>
        </div>
    </div>

    <div id="toast-box" class="fixed top-20 right-4 z-[200] flex flex-col space-y-2 pointer-events-none"></div>

    <script>
        const APP_ID = 'finsys_solo_v9_2';
        const DEFAULTS = {
            accounts: ['æ°¸è± (æ´»å­˜)', 'ç¾é‡‘', 'ä¿¡ç”¨å¡'],
            categories: {
                expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚'],
                income: ['è–ªè³‡', 'æŠ•è³‡', 'å…¶ä»–'],
                transfer: ['å…§éƒ¨è½‰å¸³', 'ç¹³è²»']
            }
        };

        let state = {
            transactions: [],
            accounts: [...DEFAULTS.accounts],
            categories: JSON.parse(JSON.stringify(DEFAULTS.categories)),
            keywordMap: {},
            settings: { currency: 'TWD' },
            ui: { view: 'view-accounts', chartYear: new Date().getFullYear(), chartMonth: 'all', tab: 'expense', catTab: 'expense' }
        };

        let splitState = { total: 0, rows: [] };
        let mainChart = null, donutChart = null;

        // --- GLOBAL FUNCS ---
        function toast(msg) {
            const box = document.getElementById('toast-box');
            const div = document.createElement('div');
            div.className = "bg-sys-bg border border-sys-blue text-sys-blue p-3 shadow-lg animate-[slideInRight_0.3s_ease-out]";
            div.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i>${msg}`;
            box.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden-force'); document.getElementById(id).classList.add('flex'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden-force'); document.getElementById(id).classList.remove('flex'); }
        function formatCurrency(n) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n); }

        function loadData() {
            const json = localStorage.getItem(APP_ID);
            if (json) {
                try {
                    const saved = JSON.parse(json);
                    state = { ...state, ...saved };
                    if (!state.categories.transfer) state.categories.transfer = DEFAULTS.categories.transfer;
                } catch (e) { console.error(e); }
            }
        }
        function saveData() { localStorage.setItem(APP_ID, JSON.stringify(state)); renderCurrentView(); }

        // --- ROUTER ---
        function changeView(id) {
            state.ui.view = id;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('text-sys-blue', 'border-t-2', 'border-sys-blue'));
            document.getElementById(id.replace('view', 'nav')).classList.add('text-sys-blue', 'border-t-2', 'border-sys-blue');
            renderCurrentView();
        }

        function renderCurrentView() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            if (state.ui.view === 'view-accounts') renderAccounts(main);
            else if (state.ui.view === 'view-dashboard') renderDashboard(main);
            else if (state.ui.view === 'view-records') renderRecords(main);
            else if (state.ui.view === 'view-settings') renderSettings(main);
        }

        // --- RENDERERS ---
        function renderAccounts(c) {
            const total = state.accounts.reduce((s, a) => s + getBal(a), 0);
            let h = `
                <div class="sys-panel p-6 mb-6 text-center">
                    <h2 class="text-sm text-sys-blue font-bold tracking-widest uppercase mb-1">ç³»çµ±ç¸½è³‡ç”¢</h2>
                    <p class="text-4xl font-bold text-white">${formatCurrency(total)}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;
            state.accounts.forEach(a => {
                const bal = getBal(a);
                h += `
                    <div class="sys-panel p-5 flex justify-between items-center cursor-pointer hover:border-sys-blue" onclick="alert('ç›®å‰é¤˜é¡: ${formatCurrency(bal)}')">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 border border-sys-blue flex items-center justify-center text-sys-blue"><i class="fa-solid fa-wallet"></i></div>
                            <span class="font-bold text-lg">${a}</span>
                        </div>
                        <span class="font-bold text-xl ${bal < 0 ? 'text-sys-danger' : 'text-sys-blue'}">${formatCurrency(bal)}</span>
                    </div>
                `;
            });
            h += `<button onclick="openAccModal()" class="sys-panel p-5 w-full flex justify-center items-center text-sys-blue/70 border-dashed border-sys-blue hover:text-sys-blue uppercase font-bold"><i class="fa-solid fa-plus-circle mr-2"></i> æ“´å……å¸³æˆ¶æ§½ä½</button></div>`;
            c.innerHTML = h;
        }

        function renderDashboard(c) {
            const y = state.ui.chartYear, m = state.ui.chartMonth;
            const prefix = m === 'all' ? `${y}-` : `${y}-${String(parseInt(m)+1).padStart(2,'0')}`;
            let inc = 0, exp = 0;
            const filtered = state.transactions.filter(t => t.date.startsWith(prefix) && !shouldExclude(t));
            
            filtered.forEach(t => {
                const amt = parseFloat(t.amount);
                if (t.type === 'income') inc += amt;
                else if (t.type === 'expense') exp += amt;
                else if (t.type === 'transfer' && t.isRealization) inc += amt;
            });

            c.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="sys-panel p-4 border-l-4 border-sys-success"><div class="text-xs text-sys-success font-bold">æ”¶å…¥</div><div class="text-2xl font-bold">${formatCurrency(inc)}</div></div>
                    <div class="sys-panel p-4 border-l-4 border-sys-danger"><div class="text-xs text-sys-danger font-bold">æ”¯å‡º</div><div class="text-2xl font-bold">${formatCurrency(exp)}</div></div>
                </div>
                <div class="sys-panel p-4 mb-6">
                    <div class="flex justify-between mb-4"><h3 class="font-bold text-sys-blue uppercase">æ”¶æ”¯è¶¨å‹¢</h3><div class="flex gap-2">
                        <select onchange="setFilter('year',this.value)" class="bg-sys-bg border border-sys-blue text-xs p-1">${getYearOpts()}</select>
                        <select onchange="setFilter('month',this.value)" class="bg-sys-bg border border-sys-blue text-xs p-1">${getMonthOpts()}</select>
                    </div></div>
                    <div class="h-48"><canvas id="chart-main"></canvas></div>
                </div>
                <div class="sys-panel p-4 mb-6">
                    <h3 class="font-bold text-sys-blue mb-4 uppercase">åˆ†é¡çµæ§‹åˆ†æ</h3>
                    <div class="flex mb-4 border-b border-sys-blue/30"><button onclick="setTab('expense')" class="flex-1 py-2 ${state.ui.tab==='expense'?'text-sys-blue border-b-2 border-sys-blue':''}">æ”¯å‡º</button><button onclick="setTab('income')" class="flex-1 py-2 ${state.ui.tab==='income'?'text-sys-blue border-b-2 border-sys-blue':''}">æ”¶å…¥</button><button onclick="setTab('excluded')" class="flex-1 py-2 ${state.ui.tab==='excluded'?'text-sys-warn border-b-2 border-sys-warn':''}">è¿½è¹¤é …</button></div>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="h-48 w-full md:w-1/2 flex justify-center"><canvas id="chart-donut"></canvas></div>
                        <div id="breakdown-list" class="w-full md:w-1/2 space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="sys-panel p-4">
                    <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase">è©²å€é–“å¸³å‹™æ˜ç´°</h4>
                    <div id="dashboard-list" class="space-y-3"></div>
                </div>
            `;
            setTimeout(() => { drawCharts(y, m); renderBreakdown(filtered); renderDashList(state.transactions.filter(t => t.date.startsWith(prefix))); }, 50);
        }

        function renderRecords(c) {
            let h = `<h2 class="text-xl font-bold text-sys-blue mb-4 uppercase">è¿‘æœŸç´€éŒ„</h2><div class="space-y-3">`;
            state.transactions.slice(0, 50).forEach(t => h += renderTxItem(t));
            h += `</div>`;
            c.innerHTML = h;
        }

        function renderTxItem(t) {
            const color = t.type==='expense'?'text-sys-danger':(t.type==='transfer'?'text-sys-blue':'text-sys-success');
            const icon = t.type==='expense'?'fa-arrow-trend-down':(t.type==='transfer'?'fa-right-left':'fa-arrow-trend-up');
            return `
                <div class="sys-panel p-4 flex justify-between items-center record-item-row hover:bg-sys-blue/5" onclick="openTxModal('${t.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 flex items-center justify-center border border-white/10 bg-white/5 ${color}"><i class="fa-solid ${icon}"></i></div>
                        <div>
                            <div class="font-bold text-sm ${color}">${t.category} ${t.isExcluded?'(ä¸è¨ˆ)':''}</div>
                            <div class="text-xs text-gray-400">${t.date} | ${t.note||'-'}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg ${color}">${t.type==='expense'?'-':(t.type==='transfer'?'':'+')}${formatCurrency(t.amount)}</div>
                        ${t.type==='transfer'?`<div class="text-xs text-gray-500">${t.accountFrom} &rarr; ${t.accountTo}</div>`:''}
                    </div>
                </div>
            `;
        }

        function renderSettings(c) {
            const accList = state.accounts.map((a, i) => `
                <div class="flex justify-between p-3 bg-sys-blue/5 border border-sys-blue/20">
                    <span>${a}</span>
                    <div class="flex gap-2">
                        <button onclick="moveAcc(${i},-1)" class="text-sys-blue"><i class="fa-solid fa-arrow-up"></i></button>
                        <button onclick="moveAcc(${i},1)" class="text-sys-blue"><i class="fa-solid fa-arrow-down"></i></button>
                        <button onclick="delAcc('${a}')" class="text-sys-danger"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
            `).join('');

            c.innerHTML = `
                <h2 class="text-xl font-bold text-sys-blue mb-6 uppercase">è¨­å®š</h2>
                <div class="sys-panel p-6 mb-6">
                    <h3 class="text-lg font-bold text-sys-blue mb-4">å¸³æˆ¶ç®¡ç†</h3>
                    <div class="flex gap-2 mb-4"><input type="text" id="new-acc-name" placeholder="åç¨±..." class="flex-1"><button onclick="addAccSet()" class="sys-btn px-4">+</button></div>
                    <div class="max-h-60 overflow-y-auto space-y-1 pr-2 custom-scrollbar">${accList}</div>
                </div>
                <div class="space-y-4">
                    <button onclick="openCatsModal()" class="sys-panel p-4 w-full text-left font-bold hover:border-sys-blue">åˆ†é¡æ¶æ§‹ç®¡ç†</button>
                    <button onclick="exportData()" class="sys-btn w-full">åŒ¯å‡ºå‚™ä»½</button>
                    <div class="relative"><button class="sys-btn w-full">åŒ¯å…¥å‚™ä»½</button><input type="file" class="absolute inset-0 opacity-0" onchange="importData(event)"></div>
                    <button onclick="resetAll()" class="sys-btn sys-btn-danger w-full">é‡ç½®ç³»çµ±</button>
                </div>
            `;
        }

        // ================= LOGIC =================
        function getBal(acc) {
            let b = 0;
            state.transactions.forEach(t => {
                const v = parseFloat(t.amount);
                if (t.accountFrom === acc) {
                    if (t.type === 'expense' || t.type === 'transfer') b -= v;
                    if (t.type === 'income') b += v;
                }
                if (t.accountTo === acc && t.type === 'transfer') b += v;
            });
            return b;
        }

        function shouldExclude(t) {
            if (t.isExcluded) return true;
            const c = (t.category || '').trim();
            return c === 'ç³»çµ±èª¿æ•´' || c === 'å¸³æˆ¶é¤˜é¡èª¿æ•´';
        }

        function getYearOpts() {
            const y = new Date().getFullYear();
            return `<option value="${y}" ${state.ui.chartYear==y?'selected':''}>${y}å¹´</option><option value="${y-1}" ${state.ui.chartYear==y-1?'selected':''}>${y-1}å¹´</option>`;
        }
        function getMonthOpts() {
            let h = `<option value="all">å…¨å¹´</option>`;
            for(let i=0;i<12;i++) h+=`<option value="${i}" ${state.ui.chartMonth==i?'selected':''}>${i+1}æœˆ</option>`;
            return h;
        }
        function setFilter(k, v) { state.ui[k==='year'?'chartYear':'chartMonth'] = v; renderCurrentView(); }
        function setTab(t) { state.ui.tab = t; renderCurrentView(); }

        // Charts
        function drawCharts(y, m) {
            const ctx = document.getElementById('chart-main');
            if(!ctx) return;
            if(mainChart) mainChart.destroy();
            
            // Data Prep
            const labels = m === 'all' ? Array.from({length:12},(_,i)=>`${i+1}æœˆ`) : ['æœ¬æœˆ'];
            const incData = new Array(labels.length).fill(0);
            const expData = new Array(labels.length).fill(0);
            
            const prefix = m === 'all' ? `${y}-` : `${y}-${String(parseInt(m)+1).padStart(2,'0')}`;
            state.transactions.filter(t => t.date.startsWith(prefix) && !shouldExclude(t)).forEach(t => {
                const d = new Date(t.date);
                const idx = m === 'all' ? d.getMonth() : 0;
                const v = parseFloat(t.amount);
                if (t.type === 'income' || (t.type==='transfer' && t.isRealization)) incData[idx] += v;
                if (t.type === 'expense') expData[idx] += v;
            });

            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æ”¶å…¥', data: incData, backgroundColor: '#33ff57' },
                        { label: 'æ”¯å‡º', data: expData, backgroundColor: '#ff3333' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{labels:{color:'#e0e0ff'}}}, scales:{x:{ticks:{color:'#e0e0ff'}},y:{ticks:{color:'#e0e0ff'}}} }
            });
        }

        function drawBreakdown(txs) {
            const list = document.getElementById('breakdown-list');
            const donut = document.getElementById('chart-donut');
            if(!list || !donut) return;
            if(donutChart) donutChart.destroy();

            const type = state.ui.tab;
            const items = txs.filter(t => type === 'excluded' ? shouldExclude(t) : (t.type === type && !shouldExclude(t)));
            const groups = {};
            let total = 0;
            items.forEach(t => {
                const v = parseFloat(t.amount);
                groups[t.category] = (groups[t.category]||0) + v;
                total += v;
            });

            const sorted = Object.entries(groups).sort((a,b) => b[1]-a[1]);
            
            if (sorted.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">ç„¡è³‡æ–™</div>';
                return;
            }

            list.innerHTML = sorted.map(([c, v]) => `
                <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1"><span>${c}</span><span>${formatCurrency(v)} (${((v/total)*100).toFixed(1)}%)</span></div>
                    <div class="w-full bg-sys-bg h-1 rounded"><div class="h-full bg-sys-blue" style="width:${(v/total)*100}%"></div></div>
                </div>
            `).join('');

            donutChart = new Chart(donut, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(i=>i[0]),
                    datasets: [{ data: sorted.map(i=>i[1]), backgroundColor: ['#00e1ff','#9d00ff','#ff3333','#33ff57','#ffbb00'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins:{legend:{display:false}} }
            });
        }

        function renderDashList(txs) {
            const c = document.getElementById('dashboard-list');
            if(!c) return;
            c.innerHTML = txs.length ? txs.map(t => renderTxItem(t)).join('') : '<div class="text-center text-gray-500 text-sm">ç„¡è³‡æ–™</div>';
        }

        // --- TX MODAL ---
        function openTxModal(id) {
            // Reset
            ['inp-id','inp-amount','inp-note'].forEach(k=>document.getElementById(k).value='');
            document.getElementById('inp-date').valueAsDate = new Date();
            document.getElementById('inp-type').value = 'expense';
            document.getElementById('chk-deferred').checked = false;
            document.getElementById('chk-realize').checked = false;
            document.getElementById('chk-exclude').checked = false;
            document.getElementById('modal-tx-title').innerText = 'æ–°å¢ç´€éŒ„';
            document.getElementById('btn-del').classList.add('hidden-force');

            // Load
            if(id) {
                const t = state.transactions.find(x => x.id === id);
                if(t) {
                    document.getElementById('inp-id').value = t.id;
                    document.getElementById('inp-date').value = t.date;
                    document.getElementById('inp-type').value = t.type;
                    document.getElementById('inp-amount').value = t.amount;
                    document.getElementById('inp-note').value = t.note;
                    document.getElementById('chk-deferred').checked = t.isVerified === false;
                    document.getElementById('chk-realize').checked = t.isRealization === true;
                    document.getElementById('chk-exclude').checked = t.isExcluded === true;
                    document.getElementById('modal-tx-title').innerText = 'ç·¨è¼¯ç´€éŒ„';
                    document.getElementById('btn-del').classList.remove('hidden-force');
                }
            }
            refreshCats();
            // Restore selects
            if(id) {
                const t = state.transactions.find(x => x.id === id);
                if(t) {
                    document.getElementById('sel-cat').value = t.category;
                    document.getElementById('sel-from').value = t.accountFrom;
                    if(t.accountTo) document.getElementById('sel-to').value = t.accountTo;
                }
            }
            openModal('modal-tx');
        }

        function refreshCats() {
            const type = document.getElementById('inp-type').value;
            document.getElementById('sel-cat').innerHTML = state.categories[type].map(c=>`<option>${c}</option>`).join('');
            const accs = state.accounts.map(a=>`<option>${a}</option>`).join('');
            document.getElementById('sel-from').innerHTML = accs;
            document.getElementById('sel-to').innerHTML = accs;

            const isTrans = type === 'transfer';
            const isInc = type === 'income';
            
            document.getElementById('grp-to').classList.toggle('hidden-force', !isTrans);
            document.getElementById('opt-realize').classList.toggle('hidden-force', !isTrans);
            document.getElementById('opt-deferred').classList.toggle('hidden-force', !isInc);
            document.getElementById('opt-exclude').classList.toggle('hidden-force', isTrans);
            document.getElementById('lbl-from').innerText = isTrans ? 'è½‰å‡ºå¸³æˆ¶' : (isInc ? 'å­˜å…¥å¸³æˆ¶' : 'æ”¯å‡ºå¸³æˆ¶');
        }

        function saveTx() {
            const id = document.getElementById('inp-id').value;
            const d = document.getElementById('inp-date').value;
            const a = parseFloat(document.getElementById('inp-amount').value);
            const t = document.getElementById('inp-type').value;
            if(!d || isNaN(a)) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™');

            const tx = {
                id: id || Date.now().toString(),
                date: d, type: t, amount: a,
                category: document.getElementById('sel-cat').value,
                accountFrom: document.getElementById('sel-from').value,
                note: document.getElementById('inp-note').value,
                isExcluded: false, isRealization: false, isVerified: true
            };

            if(t === 'transfer') {
                tx.accountTo = document.getElementById('sel-to').value;
                if(tx.accountFrom === tx.accountTo) return alert('å¸³æˆ¶ç›¸åŒ');
                tx.isRealization = document.getElementById('chk-realize').checked;
            } else {
                tx.isExcluded = document.getElementById('chk-exclude').checked;
            }
            if(t === 'income') tx.isVerified = !document.getElementById('chk-deferred').checked;

            const idx = state.transactions.findIndex(x => x.id === tx.id);
            if(idx > -1) state.transactions[idx] = tx;
            else state.transactions.unshift(tx);

            saveData();
            closeModal('modal-tx');
            toast('å·²å„²å­˜');
        }

        function delTx() {
            if(confirm('åˆªé™¤?')) {
                state.transactions = state.transactions.filter(t => t.id !== document.getElementById('inp-id').value);
                saveData();
                closeModal('modal-tx');
            }
        }

        // --- SPLIT ---
        function openSplitModal() {
            const v = document.getElementById('inp-amount').value;
            if(!v) return alert('è«‹å…ˆè¼¸å…¥ç¸½é‡‘é¡');
            splitState = { total: parseFloat(v), rows: [] };
            document.getElementById('split-total').innerText = formatCurrency(splitState.total);
            renderSplitRows();
            openModal('modal-split');
        }
        function renderSplitRows() {
            const c = document.getElementById('split-rows');
            c.innerHTML = '';
            let sum = 0;
            splitState.rows.forEach((r, i) => {
                sum += r.amt;
                c.innerHTML += `
                    <div class="sys-panel p-3 border-l-4 border-sys-purple mb-2">
                        <div class="flex gap-2 mb-2">
                            <select class="w-1/3 bg-sys-bg border border-sys-blue text-xs p-1" onchange="updSplit(${i},'type',this.value)">
                                <option value="expense" ${r.type=='expense'?'selected':''}>æ”¯å‡º</option>
                                <option value="income" ${r.type=='income'?'selected':''}>æ”¶å…¥</option>
                            </select>
                            <select class="w-2/3 bg-sys-bg border border-sys-blue text-xs p-1" id="sp-cat-${i}" onchange="updSplit(${i},'cat',this.value)"></select>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" value="${r.amt}" class="w-24 bg-sys-bg border border-sys-blue p-1 text-right" onchange="updSplit(${i},'amt',this.value)">
                            <input type="text" value="${r.note}" class="flex-1 bg-sys-bg border border-sys-blue p-1" placeholder="å‚™è¨»" onchange="updSplit(${i},'note',this.value)">
                            <button onclick="delSplit(${i})" class="text-sys-danger">âœ•</button>
                        </div>
                    </div>
                `;
                // Defer option population
                setTimeout(() => {
                    const sel = document.getElementById(`sp-cat-${i}`);
                    if(sel) {
                        sel.innerHTML = state.categories[r.type].map(c=>`<option ${c==r.cat?'selected':''}>${c}</option>`).join('');
                    }
                }, 0);
            });
            
            const rem = splitState.total - sum;
            document.getElementById('split-ghost').classList.toggle('hidden-force', rem <= 0);
            document.getElementById('split-remain').innerText = formatCurrency(rem);
            document.getElementById('split-sum').innerText = formatCurrency(sum);
        }
        function updSplit(i, k, v) {
            if(k==='amt') v = parseFloat(v);
            splitState.rows[i][k] = v;
            if(k==='type') splitState.rows[i].cat = state.categories[v][0];
            renderSplitRows();
        }
        function addSplitGhost() {
            const sum = splitState.rows.reduce((s,r)=>s+r.amt,0);
            const rem = splitState.total - sum;
            if(rem > 0) splitState.rows.push({ type: 'expense', cat: state.categories.expense[0], amt: rem, note: '' });
            renderSplitRows();
        }
        function delSplit(i) { splitState.rows.splice(i, 1); renderSplitRows(); }
        function confirmSplit() {
            const sum = splitState.rows.reduce((s,r)=>s+r.amt,0);
            if(Math.abs(sum - splitState.total) > 1) if(!confirm('é‡‘é¡ä¸ç¬¦ï¼Œç¢ºå®š?')) return;
            
            const base = {
                date: document.getElementById('inp-date').value,
                acc: document.getElementById('sel-from').value
            };
            splitState.rows.forEach(r => {
                state.transactions.unshift({
                    id: Date.now() + Math.random().toString(),
                    date: base.date, type: r.type, amount: r.amt, category: r.cat,
                    accountFrom: base.acc, note: r.note,
                    isExcluded: false, isRealization: false, isVerified: true
                });
            });
            saveData();
            closeModal('modal-split');
            closeModal('modal-tx');
            toast('æ‹†å¸³å®Œæˆ');
        }

        // --- ACCOUNT & CATS ---
        function openAccModal() {
            document.getElementById('acc-name').value = '';
            document.getElementById('acc-bal').value = '';
            openModal('modal-acc');
        }
        function saveAcc() {
            const n = document.getElementById('acc-name').value;
            const b = parseFloat(document.getElementById('acc-bal').value);
            if(!n) return;
            if(!state.accounts.includes(n)) state.accounts.push(n);
            if(!isNaN(b)) {
                const diff = b - getBal(n);
                if(diff!==0) state.transactions.unshift({
                    id: Date.now().toString(), date: new Date().toISOString().split('T')[0],
                    type: diff>0?'income':'expense', amount: Math.abs(diff),
                    category: 'å¸³æˆ¶é¤˜é¡èª¿æ•´', accountFrom: n, note: 'åˆå§‹é¤˜é¡',
                    isExcluded: false, isRealization: false, isVerified: true
                });
            }
            saveData();
            closeModal('modal-acc');
        }
        function moveAcc(i, d) {
            if((d===-1&&i>0)||(d===1&&i<state.accounts.length-1)) {
                [state.accounts[i], state.accounts[i+d]] = [state.accounts[i+d], state.accounts[i]];
                saveData();
            }
        }
        function delAcc(n) { if(confirm('åˆªé™¤?')) { state.accounts = state.accounts.filter(a=>a!==n); saveData(); } }
        function addAccSet() { 
            const n = document.getElementById('new-acc-name').value;
            if(n && !state.accounts.includes(n)) { state.accounts.push(n); saveData(); }
        }

        // Cat Logic Simplified
        function openCatsModal() { 
            state.ui.catTab = 'expense';
            renderCatList();
            openModal('modal-cats'); 
        }
        function setCatTab(t) { state.ui.catTab = t; renderCatList(); }
        function renderCatList() {
            const t = state.ui.catTab;
            const c = document.getElementById('cat-list');
            
            document.getElementById('tab-c-exp').className = `flex-1 py-2 ${t==='expense'?'text-sys-blue border-b-2 border-sys-blue':''}`;
            document.getElementById('tab-c-inc').className = `flex-1 py-2 ${t==='income'?'text-sys-blue border-b-2 border-sys-blue':''}`;

            c.innerHTML = state.categories[t].map((n, i) => `
                <div class="flex justify-between p-3 border-b border-white/10">
                    <span>${n}</span>
                    <div class="flex gap-2">
                        <button onclick="moveCat(${i},-1)">â¬†ï¸</button>
                        <button onclick="moveCat(${i},1)">â¬‡ï¸</button>
                        <button onclick="delCat('${n}')" class="text-sys-danger">âœ•</button>
                    </div>
                </div>
            `).join('');
        }
        function addCat() {
            const n = document.getElementById('new-cat').value;
            if(n) { state.categories[state.ui.catTab].push(n); saveData(); renderCatList(); }
        }
        function moveCat(i, d) {
            const arr = state.categories[state.ui.catTab];
            if((d===-1&&i>0)||(d===1&&i<arr.length-1)) {
                [arr[i], arr[i+d]] = [arr[i+d], arr[i]];
                saveData(); renderCatList();
            }
        }
        function delCat(n) {
            if(confirm('åˆªé™¤?')) {
                state.categories[state.ui.catTab] = state.categories[state.ui.catTab].filter(c=>c!==n);
                saveData(); renderCatList();
            }
        }

        // --- BACKUP ---
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = `backup_${Date.now()}.json`;
            a.click();
        }
        function importData(e) {
            const r = new FileReader();
            r.onload = (ev) => { if(confirm('é‚„åŸ?')) { state = JSON.parse(ev.target.result); saveData(); location.reload(); } };
            r.readAsText(e.target.files[0]);
        }
        function resetAll() { if(prompt('è¼¸å…¥RESET')==='RESET') { localStorage.removeItem(APP_ID); location.reload(); } }

        // Start
        window.onload();
    </script>
</body>
</html>